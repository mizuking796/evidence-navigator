<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Evidence Navigator â€” ã‚¨ãƒ“ãƒ‡ãƒ³ã‚¹ã«åŸºã¥ãåŒ»ç™‚æ–‡çŒ®æ¤œç´¢</title>
  <link rel="icon" type="image/svg+xml" href="favicon.svg">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto,
                   'Hiragino Sans', 'Noto Sans JP', sans-serif;
      background: #f1f5f9;
      color: #1e293b;
      min-height: 100vh;
      overflow-y: scroll;
    }

    /* â”€â”€ Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    header {
      background: linear-gradient(135deg, #1e3a5f 0%, #2563eb 100%);
      color: #fff;
      padding: 1.5rem 2rem;
      text-align: center;
    }
    header h1 { font-size: 1.6rem; font-weight: 700; letter-spacing: .02em; }
    header p  { font-size: .85rem; opacity: .85; margin-top: .3rem; }

    /* â”€â”€ Search Panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .search-panel {
      max-width: 800px;
      margin: 2rem auto;
      padding: 1.5rem;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 1px 3px rgba(0,0,0,.1);
      overflow: hidden;
    }
    .search-mode-tabs {
      display: flex;
      gap: .5rem;
      margin-bottom: 1rem;
      border-bottom: 2px solid #e2e8f0;
      padding-bottom: .5rem;
    }
    .mode-tab {
      padding: .4rem 1rem;
      border: none;
      background: none;
      font-size: .85rem;
      font-weight: 600;
      color: #94a3b8;
      cursor: pointer;
      border-bottom: 2px solid transparent;
      margin-bottom: -2px;
      transition: all .2s;
    }
    .mode-tab.active {
      color: #2563eb;
      border-bottom-color: #2563eb;
    }
    .mode-tab:hover { color: #475569; }
    .simple-search-row {
      display: flex;
      gap: .5rem;
      position: relative;
    }
    .simple-search-row input {
      flex: 1;
      padding: .75rem 1rem;
      border: 2px solid #cbd5e1;
      border-radius: 10px;
      font-size: 1rem;
      outline: none;
      transition: border-color .2s;
    }
    .simple-search-row input:focus { border-color: #2563eb; }
    .simple-search-row button {
      padding: .75rem 1.5rem;
      border-radius: 10px;
    }
    #q-ac {
      position: absolute;
      left: 0; right: 80px;
      top: 100%;
      z-index: 50;
    }
    .search-chips {
      display: flex;
      flex-wrap: wrap;
      gap: .4rem;
      margin-top: .6rem;
    }
    .chip {
      padding: .25rem .7rem;
      background: #f1f5f9;
      border: 1px solid #e2e8f0;
      border-radius: 20px;
      font-size: .75rem;
      color: #475569;
      cursor: pointer;
      transition: all .15s;
    }
    .chip:hover { background: #e0e7ff; border-color: #818cf8; color: #3730a3; }
    .browse-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: .8rem;
    }
    .browse-header span { font-size: .85rem; color: #475569; }
    .browse-header select {
      padding: .4rem .8rem;
      border: 1.5px solid #cbd5e1;
      border-radius: 6px;
      font-size: .8rem;
    }
    #mode-browse { min-width: 0; overflow: hidden; }
    #browse-list { max-height: 70vh; overflow-y: auto; overflow-x: hidden; }
    .browse-gl {
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      margin-bottom: .6rem;
      overflow: hidden;
    }
    .browse-gl-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: .65rem .9rem;
      background: linear-gradient(135deg, #f8fafc, #f5f3ff);
      cursor: pointer;
      font-size: .85rem;
      font-weight: 600;
      color: #1e293b;
      min-width: 0;
    }
    .browse-gl-header:hover { background: linear-gradient(135deg, #f1f5f9, #ede9fe); }
    .browse-gl-header > span:first-child {
      min-width: 0;
      flex: 1;
      margin-right: .5rem;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .browse-gl-badge {
      background: #ede9fe;
      color: #6d28d9;
      font-size: .7rem;
      padding: .1rem .5rem;
      border-radius: 10px;
    }
    .browse-gl-body { display: none; padding: .5rem; min-width: 0; overflow: hidden; }
    .browse-gl.open .browse-gl-body { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: .4rem; }
    .browse-cq {
      padding: .5rem .6rem;
      font-size: .8rem;
      display: flex;
      flex-direction: column;
      gap: .3rem;
      border-radius: 6px;
      transition: background .15s, box-shadow .15s;
      background: rgba(255,255,255,.7);
      border: 1px solid #e2e8f0;
    }
    .browse-cq:hover { background: #f5f3ff; box-shadow: 0 1px 4px rgba(139,92,246,.15); }
    .cq-evidence-panel {
      margin: .3rem 0 .5rem 0;
      padding: .5rem .7rem;
      background: linear-gradient(135deg, #faf5ff, #f0f9ff);
      border-radius: 8px;
      border-left: 3px solid #7c3aed;
      font-size: .75rem;
    }
    .cq-evidence-panel .cq-ev-loading {
      color: #7c3aed;
      display: flex;
      align-items: center;
      gap: .4rem;
    }
    .cq-evidence-panel .cq-ev-loading::before {
      content: '';
      width: 14px; height: 14px;
      border: 2px solid #c4b5fd;
      border-top-color: #7c3aed;
      border-radius: 50%;
      animation: spin .6s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .cq-ev-item {
      padding: .3rem 0;
      border-bottom: 1px solid #e2e8f0;
      line-height: 1.4;
    }
    .cq-ev-item:last-child { border-bottom: none; }
    .cq-ev-item a { color: #1e40af; text-decoration: none; }
    .cq-ev-item a:hover { text-decoration: underline; }
    .cq-ev-type {
      font-size: .6rem;
      font-weight: 700;
      padding: .05rem .3rem;
      border-radius: 3px;
      color: #fff;
      margin-right: .3rem;
    }
    .cq-ev-type-sr_ma { background: #7c3aed; }
    .cq-ev-type-rct { background: #2563eb; }
    .cq-ev-type-guideline { background: #059669; }
    .cq-ev-type-clinical_trial { background: #d97706; }
    .cq-ev-type-other { background: #94a3b8; }
    .cq-ev-meta { color: #64748b; font-size: .65rem; }
    .cq-ev-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: .3rem;
      font-weight: 600;
      color: #5b21b6;
    }
    .cq-ev-close {
      cursor: pointer;
      font-size: .7rem;
      color: #94a3b8;
      padding: .1rem .3rem;
      border-radius: 4px;
    }
    .cq-ev-close:hover { background: #e2e8f0; color: #334155; }
    .browse-cq-num {
      font-size: .65rem;
      font-weight: 700;
      color: #fff;
      background: #8b5cf6;
      padding: .1rem .4rem;
      border-radius: 4px;
      white-space: nowrap;
      flex-shrink: 0;
    }
    .browse-cq-q { color: #334155; flex: 1; min-width: 0; word-break: break-word; overflow-wrap: anywhere; }
    .browse-cq-ev {
      font-size: .6rem;
      font-weight: 700;
      padding: .1rem .35rem;
      border-radius: 4px;
      flex-shrink: 0;
      color: #fff;
      min-width: 1.2rem;
      text-align: center;
    }
    .tl-btn.loading { opacity: .5; pointer-events: none; }
    .browse-cq-ja {
      display: block;
      font-size: .78rem;
      color: #1e293b;
      line-height: 1.5;
      margin-top: .25rem;
      padding: .4rem .6rem;
      background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
      border-radius: 6px;
      border-left: 3px solid #7c3aed;
    }
    .search-fields {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 1rem;
    }
    .field { position: relative; }
    .field label {
      display: block;
      font-size: .8rem;
      font-weight: 600;
      color: #475569;
      margin-bottom: .4rem;
    }
    .field input {
      width: 100%;
      padding: .65rem .8rem;
      border: 1.5px solid #cbd5e1;
      border-radius: 8px;
      font-size: .95rem;
      outline: none;
      transition: border-color .2s;
    }
    .field input:focus {
      border-color: #2563eb;
      box-shadow: 0 0 0 3px rgba(37,99,235,.1);
    }

    /* â”€â”€ Autocomplete â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .ac-dropdown {
      display: none;
      position: absolute;
      top: 100%;
      left: 0; right: 0;
      background: #fff;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,.12);
      z-index: 100;
      max-height: 200px;
      overflow-y: auto;
      margin-top: 2px;
    }
    .ac-item {
      padding: .5rem .8rem;
      font-size: .9rem;
      cursor: pointer;
      border-bottom: 1px solid #f1f5f9;
    }
    .ac-item:last-child { border-bottom: none; }
    .ac-item:hover { background: #eff6ff; }

    /* â”€â”€ Search Actions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .search-actions { margin-top: 1rem; text-align: center; }
    #search-btn, #search-btn-adv {
      background: #2563eb;
      color: #fff;
      border: none;
      padding: .65rem 2.5rem;
      border-radius: 8px;
      font-size: .95rem;
      font-weight: 600;
      cursor: pointer;
      transition: background .2s;
    }
    #search-btn:hover, #search-btn-adv:hover { background: #1d4ed8; }
    #search-btn:disabled, #search-btn-adv:disabled { background: #94a3b8; cursor: not-allowed; }

    .search-options {
      margin-top: .8rem;
      display: flex;
      justify-content: center;
      gap: 1.5rem;
      align-items: center;
    }
    .search-options label {
      display: inline-flex;
      align-items: center;
      gap: .4rem;
      font-size: .85rem;
      color: #475569;
      cursor: pointer;
      user-select: none;
    }
    .search-options input[type="checkbox"] {
      width: 16px; height: 16px;
      accent-color: #2563eb;
      cursor: pointer;
    }
    .search-options .opt-desc {
      font-size: .7rem;
      color: #94a3b8;
    }
    .translated-info {
      max-width: 800px;
      margin: 0 auto .4rem;
      padding: 0 1.5rem;
      font-size: .8rem;
      color: #6366f1;
    }
    .translated-info span { font-weight: 600; }

    .search-hint {
      margin-top: .8rem;
      text-align: center;
      font-size: .75rem;
      color: #94a3b8;
    }

    /* â”€â”€ Legend â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .legend {
      max-width: 800px;
      margin: 0 auto .8rem;
      padding: 0 1rem;
      display: flex;
      flex-wrap: wrap;
      gap: .4rem;
      align-items: center;
      font-size: .75rem;
      color: #64748b;
    }
    .legend-title { font-weight: 600; margin-right: .3rem; }
    .legend-item {
      display: inline-flex;
      align-items: center;
      gap: .2rem;
    }
    .legend-dot {
      width: 8px; height: 8px;
      border-radius: 2px;
      display: inline-block;
    }
    .legend-sep { color: #cbd5e1; }

    /* â”€â”€ Loading â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #loading {
      display: none;
      align-items: center;
      justify-content: center;
      padding: 2rem;
      gap: .8rem;
      color: #64748b;
    }
    .spinner {
      width: 24px; height: 24px;
      border: 3px solid #e2e8f0;
      border-top-color: #2563eb;
      border-radius: 50%;
      animation: spin .8s linear infinite;
    }

    /* â”€â”€ Summary â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #summary {
      max-width: 800px;
      margin: 0 auto .5rem;
      padding: 0 1.5rem;
      font-size: .85rem;
      color: #64748b;
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
    }
    .total { font-weight: 700; color: #1e293b; }
    .src-err { color: #dc2626; }

    /* â”€â”€ Results â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #results {
      max-width: 800px;
      margin: 0 auto 3rem;
      padding: 0 1rem;
    }

    .ev-group { margin-bottom: .5rem; }
    .ev-group summary {
      display: flex;
      align-items: center;
      gap: .6rem;
      padding: .7rem 1rem;
      background: #fff;
      border-radius: 8px;
      border-left: 4px solid;
      cursor: pointer;
      user-select: none;
      list-style: none;
      box-shadow: 0 1px 2px rgba(0,0,0,.05);
      transition: background .15s;
    }
    .ev-group summary:hover { background: #f8fafc; }
    .ev-group summary::-webkit-details-marker { display: none; }
    .ev-group[open] summary { border-radius: 8px 8px 0 0; }

    .ev-badge {
      display: inline-block;
      padding: .15rem .5rem;
      border-radius: 4px;
      color: #fff;
      font-size: .75rem;
      font-weight: 700;
      min-width: 2.5rem;
      text-align: center;
    }
    .ev-label { font-weight: 600; font-size: .9rem; }
    .ev-count { margin-left: auto; font-size: .8rem; color: #94a3b8; }

    .ev-items {
      background: #fff;
      border-radius: 0 0 8px 8px;
      padding: .5rem;
    }

    /* â”€â”€ Cards â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .card {
      padding: .8rem;
      border-bottom: 1px solid #f1f5f9;
    }
    .card:last-child { border-bottom: none; }

    .card-title a {
      color: #1e40af;
      text-decoration: none;
      font-weight: 500;
      font-size: .9rem;
      line-height: 1.4;
    }
    .card-title a:hover { text-decoration: underline; }

    .card-meta {
      margin-top: .3rem;
      font-size: .8rem;
      color: #64748b;
    }
    .card-authors { margin-right: .5rem; }

    .card-tags {
      margin-top: .4rem;
      display: flex;
      flex-wrap: wrap;
      gap: .3rem;
    }
    .tag {
      display: inline-block;
      padding: .1rem .5rem;
      border-radius: 4px;
      font-size: .7rem;
      background: #f1f5f9;
      color: #475569;
    }
    .src-pubmed { background: #dbeafe; color: #1e40af; }
    .src-jstage { background: #dcfce7; color: #166534; }
    .src-s2     { background: #fce7f3; color: #9d174d; }
    .src-openalex { background: #e0e7ff; color: #3730a3; }
    .src-cinii  { background: #fef9c3; color: #854d0e; }
    .src-cochrane { background: #fde68a; color: #92400e; font-weight: 600; }
    .src-doaj   { background: #d1fae5; color: #065f46; }
    .tag-oa     { background: #d1fae5; color: #065f46; font-weight: 600; }
    .tag-cochrane { background: #fde68a; color: #92400e; font-weight: 600; }
    .tag-doi    { background: #fef3c7; color: #92400e; }
    .tl-btn {
      display: inline-flex;
      align-items: center;
      gap: .2rem;
      padding: .15rem .5rem;
      border-radius: 4px;
      font-size: .65rem;
      font-weight: 600;
      background: none;
      color: #6d28d9;
      border: 1px solid #c4b5fd;
      cursor: pointer;
      transition: all .15s;
      vertical-align: middle;
      margin-left: .3rem;
      white-space: nowrap;
    }
    .tl-btn:hover { background: #7c3aed; color: #fff; border-color: #7c3aed; }
    .tl-text {
      display: block;
      margin: .4rem 0 0;
      padding: .4rem .7rem;
      font-size: .82rem;
      color: #1e293b;
      line-height: 1.5;
      background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
      border-radius: 6px;
      border-left: 3px solid #7c3aed;
    }
    .tag-cite   { background: #f0fdf4; color: #166534; }

    .src-epmc   { background: #e8e0f0; color: #5b21b6; }

    /* â”€â”€ Toolbar (Sort + Export) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .toolbar {
      max-width: 800px;
      margin: .5rem auto;
      padding: 0 1rem;
      display: none;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: .5rem;
    }
    .sort-group, .export-group {
      display: flex;
      gap: .3rem;
      align-items: center;
    }
    .sort-group span, .export-group span {
      font-size: .75rem;
      color: #64748b;
      font-weight: 600;
      margin-right: .2rem;
    }
    .tb-btn {
      padding: .25rem .6rem;
      border: 1px solid #cbd5e1;
      border-radius: 6px;
      background: #fff;
      font-size: .75rem;
      color: #475569;
      cursor: pointer;
      transition: all .15s;
    }
    .tb-btn:hover { background: #f1f5f9; }
    .tb-btn.active { background: #2563eb; color: #fff; border-color: #2563eb; }

    /* â”€â”€ Pyramid â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */

    /* â”€â”€ Clinical Trials â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .ct-section {
      max-width: 800px;
      margin: 1rem auto;
      padding: 1.2rem;
      background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 50%, #e0f2fe 100%);
      border-radius: 12px;
      border: 2px solid #3b82f6;
      box-shadow: 0 2px 8px rgba(59,130,246,.15);
      display: none;
    }
    .ct-header {
      display: flex;
      align-items: center;
      gap: .5rem;
    }
    .ct-icon { font-size: 1.4rem; }
    .ct-title { font-size: 1rem; font-weight: 700; color: #1e40af; }
    .ct-subtitle { font-size: .72rem; color: #3b82f6; }
    .ct-count {
      margin-left: auto;
      font-size: .85rem;
      font-weight: 700;
      color: #1e40af;
    }
    .ct-items { margin-top: .8rem; }
    .ct-card {
      padding: .6rem .8rem;
      margin-bottom: .5rem;
      background: #fff;
      border-radius: 8px;
      border-left: 3px solid #3b82f6;
    }
    .ct-card-title a {
      font-size: .88rem;
      font-weight: 600;
      color: #1e3a5f;
      text-decoration: none;
    }
    .ct-card-title a:hover { text-decoration: underline; color: #2563eb; }
    .ct-card-meta {
      font-size: .72rem;
      color: #64748b;
      margin-top: .25rem;
    }
    .ct-status {
      display: inline-block;
      font-size: .65rem;
      font-weight: 600;
      padding: .1rem .4rem;
      border-radius: 4px;
      margin-right: .3rem;
    }
    .ct-status-recruiting { background: #d1fae5; color: #065f46; }
    .ct-status-completed { background: #e0e7ff; color: #3730a3; }
    .ct-status-active { background: #fef3c7; color: #92400e; }
    .ct-status-other { background: #f1f5f9; color: #475569; }
    .ct-more {
      margin-top: .5rem;
      text-align: center;
      font-size: .78rem;
      color: #2563eb;
      cursor: pointer;
    }

    .pyramid {
      max-width: 800px;
      margin: .8rem auto;
      padding: .8rem 1rem;
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 1px 2px rgba(0,0,0,.05);
      display: none;
    }
    .pyramid-title {
      font-size: .8rem;
      font-weight: 600;
      color: #475569;
      margin-bottom: .5rem;
    }
    .pyramid-row {
      display: flex;
      align-items: center;
      gap: .5rem;
      margin-bottom: .25rem;
    }
    .pyramid-label {
      width: 3rem;
      text-align: right;
      font-size: .7rem;
      font-weight: 600;
      color: #64748b;
      flex-shrink: 0;
    }
    .pyramid-bar-bg {
      flex: 1;
      height: 18px;
      background: #f1f5f9;
      border-radius: 4px;
      overflow: hidden;
    }
    .pyramid-bar {
      height: 100%;
      border-radius: 4px;
      transition: width .4s ease;
      min-width: 0;
    }
    .pyramid-val {
      width: 2.5rem;
      font-size: .7rem;
      color: #64748b;
      flex-shrink: 0;
    }
    /* â”€â”€ Empty / Error â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .no-results, .error-msg {
      text-align: center;
      padding: 2rem;
      color: #64748b;
      font-size: .9rem;
    }
    .error-msg { color: #dc2626; background: #fef2f2; border-radius: 8px; }

    /* â”€â”€ Footer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    footer {
      text-align: center;
      padding: 1.5rem;
      font-size: .75rem;
      color: #94a3b8;
    }
    footer a { color: #64748b; }

    /* â”€â”€ AI Settings â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .ai-settings {
      max-width: 800px;
      margin: 0 auto .5rem;
      padding: 0 1rem;
    }
    .ai-settings-toggle {
      display: inline-flex;
      align-items: center;
      gap: .3rem;
      font-size: .75rem;
      color: #94a3b8;
      cursor: pointer;
      background: none;
      border: none;
      padding: .3rem .5rem;
      border-radius: 6px;
      transition: all .15s;
    }
    .ai-settings-toggle:hover { color: #64748b; background: #f1f5f9; }
    .ai-settings-body {
      display: none;
      margin-top: .4rem;
      padding: .6rem .8rem;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,.08);
    }
    .ai-settings-body.open { display: block; }
    .ai-key-row {
      display: flex;
      gap: .5rem;
      align-items: center;
    }
    .ai-key-row label { font-size: .78rem; color: #475569; white-space: nowrap; }
    .ai-key-row input {
      flex: 1;
      padding: .35rem .6rem;
      border: 1px solid #cbd5e1;
      border-radius: 6px;
      font-size: .8rem;
      font-family: monospace;
    }
    .ai-key-hint {
      font-size: .7rem;
      color: #94a3b8;
      margin-top: .3rem;
    }

    /* â”€â”€ AI Summary â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .ai-summary {
      max-width: 800px;
      margin: .8rem auto;
      padding: 1rem 1.2rem;
      background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
      border-radius: 10px;
      border-left: 4px solid #0ea5e9;
      display: none;
    }
    .ai-summary-header {
      display: flex;
      align-items: center;
      gap: .4rem;
      font-size: .85rem;
      font-weight: 700;
      color: #0369a1;
      margin-bottom: .5rem;
    }
    .ai-summary-body {
      font-size: .85rem;
      line-height: 1.65;
      color: #1e293b;
    }
    .ai-summary-body strong { color: #0369a1; }
    .ai-summary-loading {
      display: flex;
      align-items: center;
      gap: .5rem;
      color: #64748b;
      font-size: .8rem;
    }
    .ai-summary-note {
      margin-top: .5rem;
      font-size: .7rem;
      color: #94a3b8;
      font-style: italic;
    }

    /* â”€â”€ National Guidelines â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .national-gl-section {
      max-width: 800px;
      margin: 1rem auto;
      padding: 1.2rem;
      background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 50%, #ecfdf5 100%);
      border-radius: 12px;
      border: 2px solid #22c55e;
      box-shadow: 0 2px 8px rgba(34,197,94,.12);
      display: none;
    }
    .ngl-header {
      display: flex;
      align-items: center;
      gap: .5rem;
      margin-bottom: .8rem;
    }
    .ngl-icon { font-size: 1.4rem; }
    .ngl-title {
      font-size: 1.05rem;
      font-weight: 800;
      color: #166534;
    }
    .ngl-subtitle {
      font-size: .72rem;
      color: #15803d;
      font-weight: 500;
    }
    .ngl-count {
      margin-left: auto;
      background: #22c55e;
      color: #fff;
      padding: .15rem .6rem;
      border-radius: 12px;
      font-size: .75rem;
      font-weight: 700;
    }
    .ngl-items {
      display: flex;
      flex-direction: column;
      gap: .3rem;
    }
    .ngl-card {
      padding: .6rem .8rem;
      background: rgba(255,255,255,.75);
      border-radius: 8px;
      border-left: 3px solid #22c55e;
      transition: background .15s;
    }
    .ngl-card:hover { background: rgba(255,255,255,.95); }
    .ngl-card .card-title a { color: #166534; }
    .ngl-org {
      font-size: .72rem;
      color: #15803d;
      margin-top: .15rem;
    }
    .ngl-cat {
      display: inline-block;
      padding: .1rem .4rem;
      border-radius: 4px;
      font-size: .65rem;
      font-weight: 600;
      background: #bbf7d0;
      color: #166534;
      margin-right: .3rem;
    }
    .ngl-more {
      margin-top: .5rem;
      text-align: center;
      font-size: .78rem;
      color: #15803d;
      cursor: pointer;
    }

    /* â”€â”€ Clinical Questions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .cq-section {
      max-width: 800px;
      margin: 1rem auto;
      padding: 1.2rem;
      background: linear-gradient(135deg, #f5f3ff 0%, #ede9fe 50%, #f0f0ff 100%);
      border-radius: 12px;
      border: 2px solid #8b5cf6;
      box-shadow: 0 2px 8px rgba(139,92,246,.12);
      display: none;
    }
    .cq-header {
      display: flex;
      align-items: center;
      gap: .5rem;
      margin-bottom: .8rem;
    }
    .cq-icon { font-size: 1.4rem; }
    .cq-title {
      font-size: 1.05rem;
      font-weight: 800;
      color: #5b21b6;
    }
    .cq-subtitle {
      font-size: .72rem;
      color: #7c3aed;
      font-weight: 500;
    }
    .cq-count {
      margin-left: auto;
      background: #8b5cf6;
      color: #fff;
      padding: .15rem .6rem;
      border-radius: 12px;
      font-size: .75rem;
      font-weight: 700;
    }
    .cq-items {
      display: flex;
      flex-direction: column;
      gap: .6rem;
    }
    .cq-gl-group {
      background: rgba(255,255,255,.5);
      border-radius: 10px;
      overflow: hidden;
    }
    .cq-gl-group-header {
      display: flex;
      align-items: center;
      gap: .4rem;
      padding: .5rem .7rem;
      background: rgba(139,92,246,.1);
      cursor: pointer;
      user-select: none;
    }
    .cq-gl-group-header:hover { background: rgba(139,92,246,.18); }
    .cq-gl-group-flag { font-size: 1rem; }
    .cq-gl-group-title {
      font-size: .82rem;
      font-weight: 700;
      color: #5b21b6;
      flex: 1;
      min-width: 0;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .cq-gl-group-org {
      font-size: .7rem;
      color: #7c3aed;
      font-weight: 400;
    }
    .cq-gl-group-badge {
      font-size: .7rem;
      font-weight: 700;
      color: #fff;
      background: #8b5cf6;
      padding: .1rem .45rem;
      border-radius: 10px;
      white-space: nowrap;
    }
    .cq-gl-group-body {
      display: none;
      padding: .4rem;
    }
    .cq-gl-group.open .cq-gl-group-body { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: .4rem; }
    .cq-card {
      padding: .55rem .65rem;
      background: rgba(255,255,255,.85);
      border-radius: 8px;
      border-left: 3px solid #8b5cf6;
      transition: background .15s;
      cursor: pointer;
    }
    .cq-card:hover { background: rgba(255,255,255,.95); box-shadow: 0 1px 4px rgba(139,92,246,.2); }
    .cq-card-top {
      display: flex;
      align-items: center;
      gap: .4rem;
      margin-bottom: .3rem;
    }
    .cq-num {
      font-size: .7rem;
      font-weight: 700;
      color: #fff;
      background: #8b5cf6;
      padding: .1rem .4rem;
      border-radius: 4px;
      white-space: nowrap;
    }
    .cq-type {
      font-size: .65rem;
      font-weight: 600;
      padding: .1rem .35rem;
      border-radius: 4px;
      background: #ddd6fe;
      color: #5b21b6;
    }
    .cq-ev-badge {
      font-size: .65rem;
      font-weight: 700;
      padding: .1rem .35rem;
      border-radius: 4px;
      color: #fff;
      min-width: 1.5rem;
      text-align: center;
    }
    .cq-ev-A { background: #059669; }
    .cq-ev-B { background: #0d9488; }
    .cq-ev-C { background: #d97706; }
    .cq-ev-D { background: #dc2626; }
    .cq-ev-na { background: #94a3b8; }
    .cq-rec {
      font-size: .65rem;
      color: #6d28d9;
      font-weight: 500;
    }
    .cq-question {
      font-size: .88rem;
      font-weight: 500;
      color: #1e1b4b;
      line-height: 1.5;
    }
    .cq-gl-info {
      font-size: .7rem;
      color: #7c3aed;
      margin-top: .25rem;
    }
    .cq-gl-info a { color: #6d28d9; text-decoration: none; }
    .cq-gl-info a:hover { text-decoration: underline; }
    .cq-page-link {
      display: inline-block;
      background: #ede9fe;
      color: #6d28d9;
      font-size: .65rem;
      padding: 0 .35rem;
      border-radius: 3px;
      margin-left: .3rem;
      font-weight: 600;
    }
    .cq-more {
      margin-top: .5rem;
      text-align: center;
      font-size: .78rem;
      color: #7c3aed;
      cursor: pointer;
    }

    /* â”€â”€ Patient Voice (ç›®ç«‹ã¤ã‚»ã‚¯ã‚·ãƒ§ãƒ³) â”€â”€â”€â”€â”€â”€ */
    .patient-voice-section {
      max-width: 800px;
      margin: 1rem auto;
      padding: 1.2rem;
      background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 50%, #fff7ed 100%);
      border-radius: 12px;
      border: 2px solid #f59e0b;
      box-shadow: 0 2px 8px rgba(245,158,11,.15);
      display: none;
    }
    .pv-header {
      display: flex;
      align-items: center;
      gap: .5rem;
      margin-bottom: .8rem;
    }
    .pv-icon {
      font-size: 1.5rem;
      line-height: 1;
    }
    .pv-title {
      font-size: 1.05rem;
      font-weight: 800;
      color: #92400e;
    }
    .pv-subtitle {
      font-size: .75rem;
      color: #b45309;
      font-weight: 500;
    }
    .pv-count {
      margin-left: auto;
      background: #f59e0b;
      color: #fff;
      padding: .15rem .6rem;
      border-radius: 12px;
      font-size: .75rem;
      font-weight: 700;
    }
    .pv-items {
      display: flex;
      flex-direction: column;
      gap: .3rem;
    }
    .pv-card {
      padding: .7rem .8rem;
      background: rgba(255,255,255,.7);
      border-radius: 8px;
      border-left: 3px solid #f59e0b;
      transition: background .15s;
    }
    .pv-card:hover { background: rgba(255,255,255,.9); }
    .pv-card .card-title a { color: #92400e; }
    .pv-card .card-meta { color: #78716c; }
    .pv-card .tag { background: #fef3c7; color: #92400e; }
    .pv-more {
      margin-top: .5rem;
      text-align: center;
      font-size: .78rem;
      color: #b45309;
      cursor: pointer;
    }

    /* â”€â”€ Responsive â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    @media (max-width: 768px) {
      .search-fields { grid-template-columns: 1fr; }
      header h1 { font-size: 1.3rem; }
      header { padding: 1.2rem 1rem; }
      .legend { font-size: .65rem; }
      .search-mode-tabs { overflow-x: auto; }
      .ai-key-row { flex-direction: column; align-items: stretch; }
      .patient-voice-section { margin: .8rem .5rem; }
    }
  </style>
</head>
<body>

<header style="cursor:pointer" onclick="location.href=location.pathname">
  <h1>Evidence Navigator</h1>
  <p>ã‚¨ãƒ“ãƒ‡ãƒ³ã‚¹ã«åŸºã¥ãåŒ»ç™‚æ–‡çŒ®æ¤œç´¢ â€” 9DBæ¨ªæ–­ + è‡¨åºŠè©¦é¨“ + ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³394ä»¶ + CQ5098ä»¶</p>
</header>

<main>
  <section class="search-panel">
    <!-- Mode tabs -->
    <div class="search-mode-tabs">
      <button class="mode-tab active" data-mode="simple" id="tab-simple">æ¤œç´¢</button>
      <button class="mode-tab" data-mode="advanced" id="tab-advanced">è©³ç´°æ¤œç´¢</button>
      <button class="mode-tab" data-mode="browse" id="tab-browse">CQãƒ–ãƒ©ã‚¦ã‚¶</button>
    </div>

    <!-- Simple search (1 box) -->
    <div class="search-mode" id="mode-simple">
      <div class="simple-search-row">
        <input type="text" id="q-input"
               placeholder="ç–¾æ‚£åãƒ»æ²»ç™‚æ³•ã‚’ã‚¹ãƒšãƒ¼ã‚¹åŒºåˆ‡ã‚Šã§å…¥åŠ›ï¼ˆä¾‹: è†é–¢ç¯€ é‹å‹•ç™‚æ³•ï¼‰"
               autocomplete="off">
        <button id="search-btn">æ¤œç´¢</button>
      </div>
      <div class="ac-dropdown" id="q-ac"></div>
      <div class="search-chips" id="search-chips">
        <span class="chip" data-q="è„³å’ä¸­ é›¢åºŠ">è„³å’ä¸­ é›¢åºŠ</span>
        <span class="chip" data-q="è…°ç—› é‹å‹•ç™‚æ³•">è…°ç—› é‹å‹•ç™‚æ³•</span>
        <span class="chip" data-q="å¿ƒä¸å…¨ ãƒªãƒãƒ“ãƒª">å¿ƒä¸å…¨ ãƒªãƒãƒ“ãƒª</span>
        <span class="chip" data-q="åš¥ä¸‹éšœå®³ è¨“ç·´">åš¥ä¸‹éšœå®³ è¨“ç·´</span>
        <span class="chip" data-q="å¤‰å½¢æ€§è†é–¢ç¯€ç—‡ ç†å­¦ç™‚æ³•">è†OA ç†å­¦ç™‚æ³•</span>
        <span class="chip" data-q="ãŒã‚“ ãƒªãƒãƒ“ãƒªãƒ†ãƒ¼ã‚·ãƒ§ãƒ³">ãŒã‚“ ãƒªãƒ</span>
        <span class="chip" data-q="èªçŸ¥ç—‡ é‹å‹•">èªçŸ¥ç—‡ é‹å‹•</span>
        <span class="chip" data-q="æ…¢æ€§ç–¼ç—› æ²»ç™‚">æ…¢æ€§ç–¼ç—›</span>
      </div>
      <div id="search-history" style="display:none;margin-top:.3rem">
        <div style="display:flex;align-items:center;gap:.4rem;margin-bottom:.3rem">
          <small style="color:#94a3b8">æœ€è¿‘ã®æ¤œç´¢</small>
          <button id="clear-history" style="border:none;background:none;color:#94a3b8;font-size:.7rem;cursor:pointer;padding:0" title="å±¥æ­´ã‚’ã‚¯ãƒªã‚¢">ã‚¯ãƒªã‚¢</button>
        </div>
        <div id="history-chips" style="display:flex;flex-wrap:wrap;gap:.3rem"></div>
      </div>
      <div class="search-options">
        <div id="search-mode-toggle" style="display:inline-flex;border:2px solid #cbd5e1;border-radius:8px;overflow:hidden;margin-right:.8rem">
          <button type="button" class="smt-btn active" data-smode="evidence" style="padding:.35rem .7rem;font-size:.8rem;font-weight:600;border:none;cursor:pointer;transition:all .2s;background:#3b82f6;color:#fff">æ–‡çŒ®æ¤œç´¢</button>
          <button type="button" class="smt-btn" data-smode="patientvoice" style="padding:.35rem .7rem;font-size:.8rem;font-weight:600;border:none;cursor:pointer;transition:all .2s;background:#fff;color:#64748b">æ‚£è€…ã®å£°</button>
        </div>
        <label>
          <input type="checkbox" id="multilingual">
          å¤šè¨€èªæ¤œç´¢
          <span class="opt-desc">ï¼ˆè‡ªå‹•ç¿»è¨³ã§è‹±èªãƒ»æ—¥æœ¬èªã‚’æ¨ªæ–­æ¤œç´¢ï¼‰</span>
        </label>
        <input type="checkbox" id="patient-voice" style="display:none">
      </div>
    </div>

    <!-- Advanced search (3 fields) -->
    <div class="search-mode" id="mode-advanced" style="display:none">
      <div class="search-fields">
        <div class="field">
          <label for="disease">ç–¾æ‚£å</label>
          <input type="text" id="disease"
                 placeholder="ä¾‹: å¤‰å½¢æ€§è†é–¢ç¯€ç—‡"
                 autocomplete="off">
          <div class="ac-dropdown" id="disease-ac"></div>
        </div>
        <div class="field">
          <label for="treatment">æ²»ç™‚æ³•</label>
          <input type="text" id="treatment"
                 placeholder="ä¾‹: é‹å‹•ç™‚æ³•"
                 autocomplete="off">
          <div class="ac-dropdown" id="treatment-ac"></div>
        </div>
        <div class="field">
          <label for="topic">é–¢å¿ƒäº‹é …</label>
          <input type="text" id="topic"
                 placeholder="ä¾‹: äºˆå¾Œ, åˆä½µç—‡"
                 autocomplete="off">
          <div class="ac-dropdown" id="topic-ac"></div>
        </div>
      </div>
      <div class="search-options">
        <label>
          <input type="checkbox" id="multilingual-adv">
          å¤šè¨€èªæ¤œç´¢
        </label>
        <label>
          <input type="checkbox" id="patient-voice-adv">
          æ‚£è€…ã®å£°ã‚’å«ã‚€
        </label>
      </div>
      <div class="search-actions">
        <button id="search-btn-adv">æ¤œç´¢</button>
      </div>
    </div>

    <!-- CQ Browser -->
    <div class="search-mode" id="mode-browse" style="display:none">
      <div style="position:relative">
        <input type="text" id="browse-filter"
               placeholder="CQã‚’ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã§çµã‚Šè¾¼ã¿ï¼ˆä¾‹: è†ã€æ­©è¡Œã€åš¥ä¸‹ï¼‰"
               autocomplete="off"
               style="width:100%;padding:.65rem 2.5rem .65rem .8rem;border:2px solid #cbd5e1;border-radius:10px;font-size:.95rem;outline:none;margin-bottom:.6rem;transition:border-color .2s">
        <span id="browse-filter-clear" style="display:none;position:absolute;right:.8rem;top:.55rem;cursor:pointer;color:#94a3b8;font-size:1.2rem;line-height:1" title="ã‚¯ãƒªã‚¢">&times;</span>
      </div>
      <div class="browse-header">
        <span id="browse-stats"></span>
        <select id="browse-cat">
          <option value="">å…¨ã‚«ãƒ†ã‚´ãƒª</option>
          <optgroup label="å›½å†…">
            <option value="PT">ç†å­¦ç™‚æ³•</option>
            <option value="OT">ä½œæ¥­ç™‚æ³•</option>
            <option value="ortho">æ•´å½¢å¤–ç§‘</option>
            <option value="neuro">ç¥çµŒå†…ç§‘</option>
            <option value="cardio">å¾ªç’°å™¨</option>
            <option value="resp">å‘¼å¸å™¨</option>
            <option value="onco">ãŒã‚“</option>
            <option value="ent">è€³é¼»ç§‘</option>
            <option value="general">ç·åˆ</option>
          </optgroup>
          <optgroup label="International">
            <option value="NICE">ğŸ‡¬ğŸ‡§ NICE (UK)</option>
            <option value="US">ğŸ‡ºğŸ‡¸ US</option>
            <option value="CA">ğŸ‡¨ğŸ‡¦ Canada</option>
            <option value="AU">ğŸ‡¦ğŸ‡º Australia</option>
            <option value="EU">ğŸ‡ªğŸ‡º EUå­¦ä¼š</option>
            <option value="CN">ğŸ‡¨ğŸ‡³ China</option>
            <option value="KR">ğŸ‡°ğŸ‡· Korea</option>
            <option value="IN">ğŸ‡®ğŸ‡³ India</option>
            <option value="BR">ğŸ‡§ğŸ‡· Brazil</option>
            <option value="DE">ğŸ‡©ğŸ‡ª Germany</option>
            <option value="WHO">ğŸŒ WHO</option>
            <option value="INT">ğŸŒ Other</option>
          </optgroup>
        </select>
        <select id="browse-country" style="padding:.35rem .5rem;border-radius:8px;border:1px solid #cbd5e1;font-size:.85rem;color:#334155;background:#fff">
          <option value="">å…¨åœ°åŸŸ</option>
          <option value="JP">ğŸ‡¯ğŸ‡µ æ—¥æœ¬ (JP)</option>
          <option value="US">ğŸ‡ºğŸ‡¸ ç±³å›½ (US)</option>
          <option value="UK">ğŸ‡¬ğŸ‡§ è‹±å›½ (UK)</option>
          <option value="EU">ğŸ‡ªğŸ‡º EU</option>
          <option value="CN">ğŸ‡¨ğŸ‡³ ä¸­å›½ (CN)</option>
          <option value="AU">ğŸ‡¦ğŸ‡º è±ªå· (AU)</option>
          <option value="CA">ğŸ‡¨ğŸ‡¦ åŠ  (CA)</option>
          <option value="KR">ğŸ‡°ğŸ‡· éŸ“å›½ (KR)</option>
          <option value="TW">ğŸ‡¹ğŸ‡¼ å°æ¹¾ (TW)</option>
          <option value="IN">ğŸ‡®ğŸ‡³ å° (IN)</option>
          <option value="DE">ğŸ‡©ğŸ‡ª ç‹¬ (DE)</option>
          <option value="IT">ğŸ‡®ğŸ‡¹ ä¼Š (IT)</option>
          <option value="ZA">ğŸ‡¿ğŸ‡¦ å—ã‚¢ (ZA)</option>
          <option value="QA">ğŸ‡¶ğŸ‡¦ ã‚«ã‚¿ãƒ¼ãƒ« (QA)</option>
          <option value="BR">ğŸ‡§ğŸ‡· ä¼¯ (BR)</option>
          <option value="INT">ğŸŒ å›½éš› (INT)</option>
        </select>
      </div>
      <div id="browse-list"></div>
    </div>
  </section>

  <!-- AI Settings -->
  <div class="ai-settings" style="display:none">
    <button class="ai-settings-toggle" id="ai-settings-btn">
      &#9881; AIæ©Ÿèƒ½è¨­å®š
    </button>
    <div class="ai-settings-body" id="ai-settings-body">
      <div class="ai-key-row">
        <label for="gemini-key">Gemini API Key:</label>
        <input type="password" id="gemini-key" placeholder="AIzaSy...">
      </div>
      <div class="ai-key-hint">
        ãƒŠãƒ©ãƒ†ã‚£ãƒ–æ¤œç´¢ãƒ»AIã‚µãƒãƒªãƒ¼ã«å¿…è¦ã§ã™ã€‚ã‚­ãƒ¼ã¯ãƒ–ãƒ©ã‚¦ã‚¶ã«ã®ã¿ä¿å­˜ã•ã‚Œã¾ã™ã€‚
        <a href="https://aistudio.google.com/apikey" target="_blank" rel="noopener">API Keyã‚’å–å¾—</a>
      </div>
    </div>
  </div>

  <div class="legend" id="legend" style="display:none">
    <span class="legend-title">ã‚¨ãƒ“ãƒ‡ãƒ³ã‚¹ãƒ¬ãƒ™ãƒ«:</span>
  </div>

  <div id="loading">
    <div class="spinner"></div>
    <span>æ¤œç´¢ä¸­...</span>
  </div>

  <div id="translated-info" class="translated-info" style="display:none"></div>
  <div id="summary"></div>

  <!-- AI Summary -->
  <div class="ai-summary" id="ai-summary">
    <div class="ai-summary-header">
      &#129302; AIã‚¨ãƒ“ãƒ‡ãƒ³ã‚¹ã‚µãƒãƒªãƒ¼
    </div>
    <div class="ai-summary-body" id="ai-summary-body">
      <div class="ai-summary-loading">
        <div class="spinner"></div>
        AIãŒæ¤œç´¢çµæœã‚’åˆ†æä¸­...
      </div>
    </div>
  </div>

  <!-- National Guidelines Section -->
  <div class="national-gl-section" id="national-gl-section">
    <div class="ngl-header">
      <span class="ngl-icon">&#128218;</span>
      <div>
        <div class="ngl-title">è¨ºç™‚ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³</div>
        <div class="ngl-subtitle">å›½å†…å¤–ã®å­¦ä¼šå…¬å¼ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³ã‹ã‚‰ã®è©²å½“æƒ…å ±</div>
      </div>
      <span class="ngl-count" id="ngl-count">0ä»¶</span>
    </div>
    <div class="ngl-items" id="ngl-items"></div>
    <div class="ngl-more" id="ngl-more" style="display:none"></div>
  </div>

  <!-- Clinical Questions Section -->
  <div class="cq-section" id="cq-section">
    <div class="cq-header">
      <span class="cq-icon">&#128269;</span>
      <div>
        <div class="cq-title">Clinical Questions</div>
        <div class="cq-subtitle">ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³ã®æ¨å¥¨ãƒ»ã‚¨ãƒ“ãƒ‡ãƒ³ã‚¹ãƒ¬ãƒ™ãƒ«</div>
      </div>
      <span class="cq-count" id="cq-count">0ä»¶</span>
    </div>
    <div class="cq-items" id="cq-items"></div>
    <div class="cq-more" id="cq-more" style="display:none"></div>
  </div>

  <!-- Patient Voice Section -->
  <div class="patient-voice-section" id="patient-voice-section">
    <div class="pv-header">
      <span class="pv-icon">&#128483;</span>
      <div>
        <div class="pv-title">æ‚£è€…ã®å£° &#183; Patient Voice</div>
        <div class="pv-subtitle">è³ªçš„ç ”ç©¶ãƒ»æ‚£è€…å ±å‘Šã‚¢ã‚¦ãƒˆã‚«ãƒ ãƒ»å½“äº‹è€…ã®ä½“é¨“</div>
      </div>
      <span class="pv-count" id="pv-count">0ä»¶</span>
    </div>
    <div class="pv-items" id="pv-items"></div>
    <div class="pv-more" id="pv-more" style="display:none"></div>
  </div>

  <!-- Clinical Trials Section -->
  <div class="ct-section" id="ct-section">
    <div class="ct-header">
      <span class="ct-icon">&#129514;</span>
      <div>
        <div class="ct-title">Clinical Trials &#183; è‡¨åºŠè©¦é¨“ãƒ¬ã‚¸ã‚¹ãƒˆãƒª</div>
        <div class="ct-subtitle">ClinicalTrials.gov â€” é€²è¡Œä¸­ãƒ»å®Œäº†æ¸ˆã¿ã®è‡¨åºŠè©¦é¨“</div>
      </div>
      <span class="ct-count" id="ct-count">0ä»¶</span>
    </div>
    <div class="ct-items" id="ct-items"></div>
    <div class="ct-more" id="ct-more" style="display:none"></div>
  </div>

  <div class="pyramid" id="pyramid">
    <div class="pyramid-title">ã‚¨ãƒ“ãƒ‡ãƒ³ã‚¹ãƒ”ãƒ©ãƒŸãƒƒãƒ‰</div>
    <div id="pyramid-bars"></div>
  </div>

  <div class="toolbar" id="toolbar">
    <div class="sort-group">
      <span>ä¸¦ã¹æ›¿ãˆ:</span>
      <button class="tb-btn active" data-sort="relevance">é–¢é€£åº¦</button>
      <button class="tb-btn" data-sort="year-desc">å¹´ â†“</button>
      <button class="tb-btn" data-sort="year-asc">å¹´ â†‘</button>
      <button class="tb-btn" data-sort="cite-desc">å¼•ç”¨æ•° â†“</button>
    </div>
    <div class="export-group">
      <span>å‡ºåŠ›:</span>
      <button class="tb-btn" id="export-csv">CSV</button>
      <button class="tb-btn" id="export-ris">RIS</button>
      <button class="tb-btn" id="export-bib">BibTeX</button>
    </div>
  </div>
  <div id="results"></div>
</main>

<footer>
  Evidence Navigator v3.1 â€”
  <a href="https://pubmed.ncbi.nlm.nih.gov/" target="_blank" rel="noopener">PubMed</a> +
  <a href="https://www.cochranelibrary.com/" target="_blank" rel="noopener">Cochrane</a> +
  <a href="https://www.jstage.jst.go.jp/" target="_blank" rel="noopener">J-STAGE</a> +
  <a href="https://www.semanticscholar.org/" target="_blank" rel="noopener">Semantic Scholar</a> +
  <a href="https://openalex.org/" target="_blank" rel="noopener">OpenAlex</a> +
  <a href="https://cir.nii.ac.jp/" target="_blank" rel="noopener">CiNii</a> +
  <a href="https://europepmc.org/" target="_blank" rel="noopener">Europe PMC</a> +
  <a href="https://doaj.org/" target="_blank" rel="noopener">DOAJ</a> +
  <a href="https://clinicaltrials.gov/" target="_blank" rel="noopener">ClinicalTrials.gov</a>
</footer>

<script>
// â”€â”€ Configuration â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const WORKER_URL = location.hostname === 'mizuking796.github.io'
  ? 'https://shintai.mizuki-tools.workers.dev'
  : 'http://localhost:8787';

const EV = {
  guideline:      { label: 'ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³',         color: '#7c3aed', abbr: 'GL'  },
  sr_ma:          { label: 'SR / ãƒ¡ã‚¿ã‚¢ãƒŠãƒªã‚·ã‚¹',   color: '#0d9488', abbr: 'SR'  },
  rct:            { label: 'RCT',                   color: '#059669', abbr: 'RCT' },
  clinical_trial: { label: 'è‡¨åºŠè©¦é¨“',              color: '#2563eb', abbr: 'CT'  },
  observational:  { label: 'è¦³å¯Ÿç ”ç©¶',              color: '#d97706', abbr: 'OBS' },
  case_report:    { label: 'ã‚±ãƒ¼ã‚¹ãƒ¬ãƒãƒ¼ãƒˆ',        color: '#0284c7', abbr: 'CR'  },
  review:         { label: 'ãƒ¬ãƒ“ãƒ¥ãƒ¼',              color: '#64748b', abbr: 'REV' },
  other:          { label: 'ãã®ä»–',                color: '#94a3b8', abbr: 'â€”'   },
};
const EV_ORDER = Object.keys(EV);

// â”€â”€ DOM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const $ = s => document.querySelector(s);
const qInput          = $('#q-input');
const diseaseInput    = $('#disease');
const treatmentInput  = $('#treatment');
const topicInput      = $('#topic');
const multilingualCb  = $('#multilingual');
const patientVoiceCb  = $('#patient-voice');
const searchBtn       = $('#search-btn');
const searchBtnAdv    = $('#search-btn-adv');
const resultsEl       = $('#results');
const loadingEl       = $('#loading');
const summaryEl       = $('#summary');
const legendEl        = $('#legend');
const translatedEl    = $('#translated-info');
const geminiKeyInput  = $('#gemini-key');
const aiSummaryEl     = $('#ai-summary');
const aiSummaryBody   = $('#ai-summary-body');
const nglSection      = $('#national-gl-section');
const nglItemsEl      = $('#ngl-items');
const nglCountEl      = $('#ngl-count');
const cqSection       = $('#cq-section');
const cqItemsEl       = $('#cq-items');
const cqCountEl       = $('#cq-count');
const pvSection       = $('#patient-voice-section');
const pvItemsEl       = $('#pv-items');
const pvCountEl       = $('#pv-count');
const ctSection       = $('#ct-section');
const ctItemsEl       = $('#ct-items');
const ctCountEl       = $('#ct-count');

// â”€â”€ Suggest Autocomplete â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function initSuggest(input, dropdown, useLocalSuggest) {
  let suggestTimer = null;
  input.addEventListener('input', () => {
    clearTimeout(suggestTimer);
    const raw = input.value.trim();
    // For simple search: use last word for suggestions
    const words = raw.split(/\s+/);
    const q = words[words.length - 1];
    if (q.length < 1) { dropdown.style.display = 'none'; return; }

    // 'auto' mode: Japanese â†’ local suggest, English â†’ MeSH
    let useLocal = useLocalSuggest;
    if (useLocalSuggest === 'auto') {
      useLocal = /[\u3000-\u9FFF\u30A0-\u30FF\u3040-\u309F]/.test(q);
    }

    suggestTimer = setTimeout(async () => {
      try {
        const endpoint = useLocal
          ? `${WORKER_URL}/api/suggest?q=${encodeURIComponent(q)}`
          : `${WORKER_URL}/api/mesh?q=${encodeURIComponent(q)}`;
        const res = await fetch(endpoint);
        const items = await res.json();
        if (items.length) {
          dropdown.innerHTML = items
            .map(s => `<div class="ac-item">${esc(s)}</div>`)
            .join('');
          dropdown.style.display = 'block';
          dropdown.querySelectorAll('.ac-item').forEach(el => {
            el.addEventListener('mousedown', e => {
              e.preventDefault();
              if (useLocalSuggest && words.length > 1) {
                // Replace last word with suggestion
                words[words.length - 1] = el.textContent;
                input.value = words.join(' ') + ' ';
              } else {
                input.value = el.textContent;
              }
              dropdown.style.display = 'none';
            });
          });
        } else {
          dropdown.style.display = 'none';
        }
      } catch {
        dropdown.style.display = 'none';
      }
    }, 200);
  });

  input.addEventListener('blur', () => {
    setTimeout(() => (dropdown.style.display = 'none'), 200);
  });
  input.addEventListener('keydown', e => {
    if (e.key === 'Escape') dropdown.style.display = 'none';
    if (e.key === 'Enter') { dropdown.style.display = 'none'; doSearch(); }
  });
}

// Advanced fields: use local suggest for Japanese, MeSH for English
function initAutocomplete(input, dropdown) {
  initSuggest(input, dropdown, 'auto');
}

function esc(s) {
  const d = document.createElement('div');
  d.textContent = s;
  return d.innerHTML;
}

// â”€â”€ Search History â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const HISTORY_KEY = 'en-search-history';
const HISTORY_MAX = 10;

function getSearchHistory() {
  try { return JSON.parse(localStorage.getItem(HISTORY_KEY)) || []; } catch { return []; }
}

function addSearchHistory(query) {
  if (!query) return;
  let h = getSearchHistory().filter(q => q !== query);
  h.unshift(query);
  if (h.length > HISTORY_MAX) h = h.slice(0, HISTORY_MAX);
  localStorage.setItem(HISTORY_KEY, JSON.stringify(h));
  renderSearchHistory();
}

function renderSearchHistory() {
  const h = getSearchHistory();
  const container = $('#search-history');
  const chips = $('#history-chips');
  if (!h.length) { container.style.display = 'none'; return; }
  container.style.display = 'block';
  chips.innerHTML = h.map(q =>
    `<span class="chip" style="background:#f1f5f9;color:#475569;font-size:.8rem;padding:.2rem .5rem" data-hq="${esc(q)}">${esc(q)}</span>`
  ).join('');
  chips.querySelectorAll('.chip').forEach(el => {
    el.addEventListener('click', () => { qInput.value = el.dataset.hq; doSearch(); });
  });
}

// â”€â”€ Search â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let abortCtrl = null;
let lastData = null;  // stored for sort/export

function getApiKey() {
  return geminiKeyInput.value.trim() || localStorage.getItem('geminiKey') || '';
}

async function doSearch() {
  // Check which mode is active
  const simpleMode = $('#mode-simple').style.display !== 'none';
  if (simpleMode) {
    const q = qInput.value.trim();
    if (!q) return;
    await executeSearch({ q });
  } else {
    const disease   = diseaseInput.value.trim();
    const treatment = treatmentInput.value.trim();
    const topic     = topicInput.value.trim();
    if (!disease && !treatment && !topic) return;
    await executeSearch({ disease, treatment, topic });
  }
}

function resetUI() {
  resultsEl.innerHTML = '';
  summaryEl.innerHTML = '';
  legendEl.style.display = 'none';
  translatedEl.style.display = 'none';
  aiSummaryEl.style.display = 'none';
  nglSection.style.display = 'none';
  cqSection.style.display = 'none';
  pvSection.style.display = 'none';
  $('#pyramid').style.display = 'none';
  $('#toolbar').style.display = 'none';
}

async function executeSearch({ q, disease, treatment, topic }) {
  if (!q && !disease && !treatment && !topic) return;

  // Save to history
  addSearchHistory(q || [disease, treatment, topic].filter(Boolean).join(' '));

  // Abort previous
  if (abortCtrl) abortCtrl.abort();
  abortCtrl = new AbortController();

  const simpleMode = !!q;
  const mlCb = simpleMode ? multilingualCb : $('#multilingual-adv');
  const pvCb = simpleMode ? patientVoiceCb : $('#patient-voice-adv');
  const multilingual = mlCb ? mlCb.checked : false;
  const pvToggleActive = document.querySelector('.smt-btn[data-smode="patientvoice"]')?.classList.contains('active');
  const patientVoice = pvToggleActive || (pvCb ? pvCb.checked : false);
  const btn = simpleMode ? searchBtn : searchBtnAdv;

  if (btn) btn.disabled = true;
  loadingEl.style.display = 'flex';
  loadingEl.querySelector('span').textContent =
    pvToggleActive ? 'æ‚£è€…ã®å£°ã‚’æ¤œç´¢ä¸­...' : multilingual ? 'å¤šè¨€èªæ¨ªæ–­æ¤œç´¢ä¸­...' : 'æ¤œç´¢ä¸­...';
  resetUI();

  try {
    const params = new URLSearchParams();
    if (q) params.set('q', q);
    if (disease)   params.set('disease', disease);
    if (treatment) params.set('treatment', treatment);
    if (topic)     params.set('topic', topic);
    if (multilingual) params.set('multilingual', 'true');
    if (patientVoice) params.set('patientVoice', 'true');

    const res = await fetch(`${WORKER_URL}/api/search?${params}`, {
      signal: abortCtrl.signal,
    });
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();

    if (data.error) throw new Error(data.error);

    lastData = data;

    if (pvToggleActive) {
      // Patient Voice only mode: show only PV results, hide everything else
      renderNationalGuidelines(null);
      renderClinicalQuestions(null);
      renderClinicalTrials(null);
      renderPyramid({}, null, null);
      resultsEl.innerHTML = '';
      $('#toolbar').style.display = 'none';
      legendEl.style.display = 'none';
      renderPatientVoice(data.patientVoice);
      // Minimal summary
      summaryEl.innerHTML = data.patientVoice && data.patientVoice.length
        ? `<span class="total">${data.patientVoice.length}ä»¶</span><span class="src" style="color:#b45309">æ‚£è€…ã®å£°ãƒ»è³ªçš„ç ”ç©¶</span>`
        : `<span style="color:#94a3b8">è©²å½“ã™ã‚‹è³ªçš„ç ”ç©¶ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ</span>`;
      summaryEl.style.display = 'block';
    } else {
      renderLegend();
      renderTranslated(data.multilingual);
      renderSummary(data);
      renderNationalGuidelines(data.nationalGuidelines);
      renderClinicalQuestions(data.clinicalQuestions);
      renderPatientVoice(data.patientVoice);
      renderClinicalTrials(data.clinicalTrials);
      renderPyramid(data.results, data.nationalGuidelines, data.clinicalQuestions);
      renderResults(data.results);
      showToolbar();
    }

    history.replaceState(null, '', `?${params}`);

    // Async: AI Summary (non-blocking)
    const apiKey = getApiKey();
    if (apiKey && data.totalCount > 0) {
      requestAISummary(data, apiKey);
    }
  } catch (e) {
    if (e.name === 'AbortError') return;
    resultsEl.innerHTML =
      `<div class="error-msg">æ¤œç´¢ã‚¨ãƒ©ãƒ¼: ${esc(e.message)}<br>` +
      `Workerï¼ˆ<code>${esc(WORKER_URL)}</code>ï¼‰ãŒèµ·å‹•ã—ã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚</div>`;
  } finally {
    if (btn) btn.disabled = false;
    loadingEl.style.display = 'none';
  }
}

// â”€â”€ AI Summary (async, non-blocking) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function requestAISummary(data, apiKey) {
  aiSummaryEl.style.display = 'block';
  aiSummaryBody.innerHTML =
    '<div class="ai-summary-loading"><div class="spinner"></div>AIãŒæ¤œç´¢çµæœã‚’åˆ†æä¸­...</div>';

  try {
    const res = await fetch(`${WORKER_URL}/api/ai/summary`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        results: data.results,
        query: data.query,
        apiKey,
      }),
    });
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const result = await res.json();
    if (result.error) throw new Error(result.error);

    // Convert markdown-like formatting to HTML (escape first to prevent XSS)
    const html = esc(result.summary)
      .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
      .replace(/^- /gm, '&bull; ')
      .replace(/\n/g, '<br>');
    aiSummaryBody.innerHTML = html +
      '<div class="ai-summary-note">â€» è«–æ–‡ã‚¿ã‚¤ãƒˆãƒ«ã‹ã‚‰ã®æ¨å¯Ÿã§ã‚ã‚Šã€å…¨æ–‡ãƒ¬ãƒ“ãƒ¥ãƒ¼ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</div>';
  } catch (e) {
    aiSummaryBody.innerHTML =
      `<div style="color:#dc2626;font-size:.8rem">AIã‚µãƒãƒªãƒ¼ç”Ÿæˆã‚¨ãƒ©ãƒ¼: ${esc(e.message)}</div>`;
  }
}

// â”€â”€ National Guidelines Render â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderNationalGuidelines(items) {
  if (!items || !items.length) {
    nglSection.style.display = 'none';
    return;
  }

  nglSection.style.display = 'block';
  nglCountEl.textContent = `${items.length}ä»¶`;

  const showLimit = 5;
  const visible = items.slice(0, showLimit);
  const hidden = items.slice(showLimit);

  nglItemsEl.innerHTML = visible.map(gl => `
    <div class="ngl-card">
      <div class="card-title">
        <span class="ngl-cat">${esc(gl.category)}</span>
        <a href="${esc(gl.url)}" target="_blank" rel="noopener">${esc(gl.title)}</a>
      </div>
      <div class="ngl-org">${esc(gl.organization)}ï¼ˆ${gl.year || ''}ï¼‰</div>
    </div>`).join('');

  const nglMore = $('#ngl-more');
  if (hidden.length > 0) {
    nglMore.textContent = `+ ${hidden.length}ä»¶ã‚’ã•ã‚‰ã«è¡¨ç¤º`;
    nglMore.style.display = 'block';
    nglMore.onclick = () => {
      nglItemsEl.innerHTML += hidden.map(gl => `
        <div class="ngl-card">
          <div class="card-title">
            <span class="ngl-cat">${esc(gl.category)}</span>
            <a href="${esc(gl.url)}" target="_blank" rel="noopener">${esc(gl.title)}</a>
          </div>
          <div class="ngl-org">${esc(gl.organization)}ï¼ˆ${gl.year || ''}ï¼‰</div>
        </div>`).join('');
      nglMore.style.display = 'none';
    };
  } else {
    nglMore.style.display = 'none';
  }
}

// â”€â”€ Clinical Questions Render â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderClinicalQuestions(items) {
  if (!items || !items.length) {
    cqSection.style.display = 'none';
    return;
  }

  cqSection.style.display = 'block';

  // Group by guideline
  const groups = new Map();
  for (const cq of items) {
    const key = cq.gid || cq.guidelineTitle;
    if (!groups.has(key)) {
      groups.set(key, {
        title: cq.guidelineTitle,
        org: cq.guidelineOrg,
        url: cq.guidelineUrl,
        country: cq.country || 'JP',
        cqs: [],
        topScore: cq.score || 0,
      });
    }
    groups.get(key).cqs.push(cq);
  }

  // Sort groups by top score descending
  const sorted = [...groups.values()].sort((a, b) => b.topScore - a.topScore);
  const totalCQs = items.length;
  const glCount = sorted.length;
  cqCountEl.textContent = `${totalCQs}ä»¶ / ${glCount} GL`;

  // Show first 5 groups, hide rest
  const showLimit = 5;
  const visibleGroups = sorted.slice(0, showLimit);
  const hiddenGroups = sorted.slice(showLimit);

  cqItemsEl.innerHTML = visibleGroups.map((g, i) => renderCQGroup(g, i === 0)).join('');

  const cqMore = $('#cq-more');
  if (hiddenGroups.length > 0) {
    const hiddenCQs = hiddenGroups.reduce((s, g) => s + g.cqs.length, 0);
    cqMore.textContent = `+ ${hiddenGroups.length} GLï¼ˆ${hiddenCQs} CQsï¼‰ã‚’ã•ã‚‰ã«è¡¨ç¤º`;
    cqMore.style.display = 'block';
    cqMore.onclick = () => {
      cqItemsEl.innerHTML += hiddenGroups.map(g => renderCQGroup(g, false)).join('');
      cqMore.style.display = 'none';
    };
  } else {
    cqMore.style.display = 'none';
  }
}

function renderCQGroup(g, autoOpen) {
  const flag = CQ_FLAGS[g.country] || '';
  return `
    <div class="cq-gl-group${autoOpen ? ' open' : ''}">
      <div class="cq-gl-group-header" onclick="this.parentElement.classList.toggle('open')">
        <span class="cq-gl-group-flag">${flag}</span>
        <span class="cq-gl-group-title">${esc(g.title)}
          ${g.url ? `<a href="${esc(g.url)}" target="_blank" rel="noopener" onclick="event.stopPropagation()" title="ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³åŸæ–‡ã‚’é–‹ã" style="display:inline-flex;align-items:center;gap:.2rem;margin-left:.3rem;padding:.1rem .4rem;background:#6d28d9;color:#fff;font-size:.6rem;font-weight:600;border-radius:4px;text-decoration:none;white-space:nowrap;vertical-align:middle">åŸæ–‡ &#8599;</a>` : ''}
          <span class="cq-gl-group-org">${g.org ? esc(g.org) : ''}</span>
        </span>
        <span class="cq-gl-group-badge">${g.cqs.length}</span>
      </div>
      <div class="cq-gl-group-body">
        ${g.cqs.map(renderCQCard).join('')}
      </div>
    </div>`;
}

const CQ_FLAGS = {JP:'\u{1F1EF}\u{1F1F5}',US:'\u{1F1FA}\u{1F1F8}',UK:'\u{1F1EC}\u{1F1E7}',EU:'\u{1F1EA}\u{1F1FA}',CN:'\u{1F1E8}\u{1F1F3}',AU:'\u{1F1E6}\u{1F1FA}',CA:'\u{1F1E8}\u{1F1E6}',KR:'\u{1F1F0}\u{1F1F7}',TW:'\u{1F1F9}\u{1F1FC}',IN:'\u{1F1EE}\u{1F1F3}',DE:'\u{1F1E9}\u{1F1EA}',IT:'\u{1F1EE}\u{1F1F9}',ZA:'\u{1F1FF}\u{1F1E6}',QA:'\u{1F1F6}\u{1F1E6}',BR:'\u{1F1E7}\u{1F1F7}',INT:'\u{1F30D}',INTL:'\u{1F30D}'};

function renderCQCard(cq) {
  const evClass = cq.evidenceLevel === '-' ? 'cq-ev-na' : `cq-ev-${cq.evidenceLevel}`;
  const evLabel = cq.evidenceLevel === '-' ? '-' : cq.evidenceLevel;
  const href = cq.guidelineUrl ? `${esc(cq.guidelineUrl)}${cq.page ? '#page=' + cq.page : ''}` : '';
  return `
    <a class="cq-card" ${href ? `href="${href}" target="_blank" rel="noopener"` : ''} style="display:block;text-decoration:none;color:inherit">
      <div class="cq-card-top">
        <span class="cq-num">${esc(cq.cq)}</span>
        <span class="cq-type">${esc(cq.type)}</span>
        <span class="cq-ev-badge ${evClass}" title="ã‚¨ãƒ“ãƒ‡ãƒ³ã‚¹ã®å¼·ã•">${evLabel}</span>
      </div>
      <div class="cq-question">${esc(cq.question)}</div>
      ${cq.recommendation ? `<div class="cq-rec">${esc(cq.recommendation)}</div>` : ''}
    </a>`;
}

// â”€â”€ Patient Voice Render â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderPatientVoice(items) {
  if (!items || !items.length) {
    pvSection.style.display = 'none';
    return;
  }

  pvSection.style.display = 'block';
  pvCountEl.textContent = `${items.length}ä»¶`;

  const showLimit = 5;
  const visible = items.slice(0, showLimit);
  const hidden = items.slice(showLimit);

  pvItemsEl.innerHTML = visible.map(item => {
    const srcMap = {
      'PubMed': 'src-pubmed', 'J-STAGE': 'src-jstage', 'Semantic Scholar': 'src-s2',
      'OpenAlex': 'src-openalex', 'CiNii': 'src-cinii', 'Europe PMC': 'src-epmc',
      'Cochrane': 'src-cochrane', 'DOAJ': 'src-doaj',
    };
    const srcName = s => s === 'Semantic Scholar' ? 'S2' : s === 'Europe PMC' ? 'EPMC' : s;
    const sources = item.foundIn || [item.source];
    let tags = sources.map(s =>
      `<span class="tag ${srcMap[s] || ''}">${srcName(s)}</span>`
    ).join('');
    if (item.year) tags += `<span class="tag">${esc(String(item.year))}</span>`;
    if (item.citations) tags += `<span class="tag tag-cite">cited: ${esc(String(item.citations))}</span>`;

    const authors = item.authors?.length
      ? item.authors.join(', ') + (item.authors.length >= 5 ? ' et al.' : '')
      : '';

    const pvTid = 'tl-' + Math.random().toString(36).slice(2, 8);
    const pvIsJa = /[\u3000-\u9FFF\u30A0-\u30FF\u3040-\u309F]/.test(item.title);
    const pvTlLabel = pvIsJa ? 'EN' : 'è¨³';
    return `
      <div class="pv-card">
        <div class="card-title">
          <a href="${esc(item.url)}" target="_blank" rel="noopener">${esc(item.title)}</a>
          <span class="tl-btn" data-tid="${pvTid}" data-title="${esc(item.title)}">${pvTlLabel}</span>
          <span id="${pvTid}"></span>
        </div>
        <div class="card-meta">
          <span class="card-authors">${esc(authors)}</span>
          <span class="card-journal">${esc(item.journal || '')}</span>
        </div>
        <div class="card-tags">${tags}</div>
      </div>`;
  }).join('');

  const pvMore = $('#pv-more');
  if (hidden.length > 0) {
    pvMore.textContent = `+ ${hidden.length}ä»¶ã‚’ã•ã‚‰ã«è¡¨ç¤º`;
    pvMore.style.display = 'block';
    pvMore.onclick = () => {
      pvItemsEl.innerHTML += hidden.map(item => {
        const authors = item.authors?.length ? item.authors.join(', ') : '';
        return `<div class="pv-card">
          <div class="card-title"><a href="${esc(item.url)}" target="_blank" rel="noopener">${esc(item.title)}</a></div>
          <div class="card-meta">${esc(authors)} ${esc(item.journal || '')} ${item.year || ''}</div>
        </div>`;
      }).join('');
      pvMore.style.display = 'none';
    };
  } else {
    pvMore.style.display = 'none';
  }
}

// â”€â”€ Render Legend â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderLegend() {
  legendEl.style.display = 'flex';
  if (legendEl.dataset.built) return;
  legendEl.dataset.built = '1';

  for (let i = 0; i < EV_ORDER.length; i++) {
    const info = EV[EV_ORDER[i]];
    if (i > 0) {
      const sep = document.createElement('span');
      sep.className = 'legend-sep';
      sep.textContent = '>';
      legendEl.appendChild(sep);
    }
    const item = document.createElement('span');
    item.className = 'legend-item';
    item.innerHTML =
      `<span class="legend-dot" style="background:${info.color}"></span>${info.label}`;
    legendEl.appendChild(item);
  }
}

// â”€â”€ Render Translation Info â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderTranslated(ml) {
  if (!ml || !ml.translated) {
    translatedEl.style.display = 'none';
    return;
  }
  const { disease, treatment, topic } = ml.translated;
  const parts = [];
  if (disease)   parts.push(`ç–¾æ‚£å: <span>${esc(disease)}</span>`);
  if (treatment) parts.push(`æ²»ç™‚æ³•: <span>${esc(treatment)}</span>`);
  if (topic)     parts.push(`é–¢å¿ƒäº‹é …: <span>${esc(topic)}</span>`);
  if (parts.length) {
    translatedEl.innerHTML = 'ç¿»è¨³æ¤œç´¢èª â†’ ' + parts.join(' / ');
    translatedEl.style.display = 'block';
  } else {
    translatedEl.style.display = 'none';
  }
}


// â”€â”€ Render Clinical Trials â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderClinicalTrials(trials) {
  if (!trials || !trials.length) {
    ctSection.style.display = 'none';
    return;
  }
  ctSection.style.display = 'block';
  ctCountEl.textContent = `${trials.length}ä»¶`;

  const statusClass = s => {
    const sl = (s || '').toLowerCase();
    if (sl.includes('recruit')) return 'ct-status-recruiting';
    if (sl.includes('complet')) return 'ct-status-completed';
    if (sl.includes('active') || sl.includes('ongoing')) return 'ct-status-active';
    return 'ct-status-other';
  };
  const statusLabel = s => {
    const map = {
      'RECRUITING': 'å‹Ÿé›†ä¸­', 'ACTIVE_NOT_RECRUITING': 'é€²è¡Œä¸­',
      'COMPLETED': 'å®Œäº†', 'TERMINATED': 'ä¸­æ­¢', 'WITHDRAWN': 'å–ä¸‹ã’',
      'NOT_YET_RECRUITING': 'æœªé–‹å§‹', 'ENROLLING_BY_INVITATION': 'æ‹›å¾…åˆ¶',
      'SUSPENDED': 'ä¸­æ–­', 'UNKNOWN': 'ä¸æ˜',
    };
    return map[s] || s || '';
  };

  const showLimit = 5;
  const visible = trials.slice(0, showLimit);
  const hidden = trials.slice(showLimit);

  ctItemsEl.innerHTML = visible.map(t => `
    <div class="ct-card">
      <div class="ct-card-title">
        <span class="ct-status ${statusClass(t.status)}">${esc(statusLabel(t.status))}</span>
        <a href="${esc(t.url)}" target="_blank" rel="noopener">${esc(t.briefTitle || t.title)}</a>
      </div>
      <div class="ct-card-meta">
        ${t.nctId ? `<span>${esc(t.nctId)}</span>` : ''}
        ${t.phase !== 'N/A' && t.phase ? ` | Phase: ${esc(t.phase)}` : ''}
        ${t.enrollment ? ` | N=${t.enrollment}` : ''}
        ${t.conditions?.length ? ` | ${t.conditions.slice(0,3).map(c => esc(c)).join(', ')}` : ''}
      </div>
    </div>
  `).join('');

  const ctMore = $('#ct-more');
  if (hidden.length > 0) {
    ctMore.textContent = `+ ${hidden.length}ä»¶ã‚’ã•ã‚‰ã«è¡¨ç¤º`;
    ctMore.style.display = 'block';
    ctMore.onclick = () => {
      ctItemsEl.innerHTML += hidden.map(t => `
        <div class="ct-card">
          <div class="ct-card-title">
            <span class="ct-status ${statusClass(t.status)}">${esc(statusLabel(t.status))}</span>
            <a href="${esc(t.url)}" target="_blank" rel="noopener">${esc(t.briefTitle || t.title)}</a>
          </div>
          <div class="ct-card-meta">
            ${t.nctId ? `<span>${esc(t.nctId)}</span>` : ''}
            ${t.phase !== 'N/A' && t.phase ? ` | Phase: ${esc(t.phase)}` : ''}
            ${t.enrollment ? ` | N=${t.enrollment}` : ''}
          </div>
        </div>
      `).join('');
      ctMore.style.display = 'none';
    };
  } else {
    ctMore.style.display = 'none';
  }
}

// â”€â”€ Render Summary â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderSummary(data) {
  const { totalCount, sources } = data;
  const glCount = data.nationalGuidelines ? data.nationalGuidelines.length : 0;
  const cqCount = data.clinicalQuestions ? data.clinicalQuestions.length : 0;
  const ctCount = data.clinicalTrials ? data.clinicalTrials.length : 0;
  const grandTotal = totalCount + glCount + cqCount + ctCount;
  const srcNames = [
    ['pubmed', 'PubMed'], ['cochrane', 'Cochrane'], ['jstage', 'J-STAGE'], ['s2', 'S2'],
    ['openalex', 'OpenAlex'], ['cinii', 'CiNii'], ['epmc', 'EPMC'], ['doaj', 'DOAJ'],
  ];
  let html = `<span class="total">${grandTotal}ä»¶</span>`;
  if (glCount) html += `<span class="src" style="color:#166534">GL: ${glCount}ä»¶</span>`;
  if (cqCount) html += `<span class="src" style="color:#6d28d9">CQ: ${cqCount}ä»¶</span>`;
  if (ctCount) html += `<span class="src" style="color:#1e40af">CT: ${ctCount}ä»¶</span>`;
  for (const [key, name] of srcNames) {
    if (sources[key]) html += `<span class="src">${name}: ${sources[key]}ä»¶</span>`;
  }
  const errors = sources.errors || {};
  for (const [key, msg] of Object.entries(errors)) {
    if (msg) html += `<span class="src-err">${key}: ${esc(msg)}</span>`;
  }
  summaryEl.innerHTML = html;
}

// â”€â”€ Render Results â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderResults(grouped) {
  let html = '';
  let hasAny = false;

  for (const level of EV_ORDER) {
    const items = grouped[level] || [];
    if (!items.length) continue;
    hasAny = true;

    const info = EV[level];
    // Auto-open top 3 evidence levels
    const open = ['guideline', 'sr_ma', 'rct'].includes(level) ? 'open' : '';

    html += `
      <details class="ev-group" ${open}>
        <summary style="border-left-color:${info.color}">
          <span class="ev-badge" style="background:${info.color}">${info.abbr}</span>
          <span class="ev-label">${info.label}</span>
          <span class="ev-count">${items.length}ä»¶</span>
        </summary>
        <div class="ev-items">
          ${items.map(renderCard).join('')}
        </div>
      </details>`;
  }

  if (!hasAny) {
    html = '<div class="no-results">è©²å½“ã™ã‚‹æ–‡çŒ®ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚<br>æ¤œç´¢èªã‚’å¤‰ãˆã¦ãŠè©¦ã—ãã ã•ã„ã€‚</div>';
  }

  resultsEl.innerHTML = html;
}

function renderCard(item, prefixBadge) {
  const authors = item.authors.length
    ? item.authors.join(', ') + (item.authors.length >= 5 ? ' et al.' : '')
    : '';
  const year = item.year ? `(${item.year})` : '';
  const srcMap = {
    'PubMed': 'src-pubmed', 'J-STAGE': 'src-jstage', 'Semantic Scholar': 'src-s2',
    'OpenAlex': 'src-openalex', 'CiNii': 'src-cinii', 'Europe PMC': 'src-epmc',
    'Cochrane': 'src-cochrane', 'DOAJ': 'src-doaj',
  };
  const srcName = s => s === 'Semantic Scholar' ? 'S2' : s === 'Europe PMC' ? 'EPMC' : s;
  const sources = item.foundIn || [item.source];

  let tags = sources.map(s =>
    `<span class="tag ${srcMap[s] || ''}">${srcName(s)}</span>`
  ).join('');
  if (item.isCochrane) tags += `<span class="tag tag-cochrane">Cochrane SR</span>`;
  if (item.openAccess) tags += `<span class="tag tag-oa">Open Access</span>`;
  if (item.citations)
    tags += `<span class="tag tag-cite">cited: ${item.citations}</span>`;
  if (item.doi)
    tags += `<span class="tag tag-doi">DOI</span>`;
  for (const pt of (item.pubTypes || [])) {
    tags += `<span class="tag">${esc(pt)}</span>`;
  }

  const tid = 'tl-' + Math.random().toString(36).slice(2, 8);
  const isJa = /[\u3000-\u9FFF\u30A0-\u30FF\u3040-\u309F]/.test(item.title);
  const tlLabel = isJa ? 'EN' : 'è¨³';
  return `
    <div class="card">
      <div class="card-title">
        ${prefixBadge || ""}<a href="${esc(item.url)}" target="_blank" rel="noopener">${esc(item.title)}</a>
        <span class="tl-btn" data-tid="${tid}" data-title="${esc(item.title)}">${tlLabel}</span>
        <span id="${tid}"></span>
      </div>
      <div class="card-meta">
        <span class="card-authors">${esc(authors)}</span>
        <span class="card-journal">${esc(item.journal)} ${year}</span>
      </div>
      <div class="card-tags">${tags}</div>
    </div>`;
}


// â”€â”€ Title Translation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function translateTitle(btn) {
  const tid = btn.dataset.tid;
  const title = btn.dataset.title;
  const el = document.getElementById(tid);
  if (!el) return;
  if (el.dataset.done) { el.style.display = el.style.display === 'none' ? 'block' : 'none'; return; }
  btn.textContent = '...';
  try {
    const res = await fetch(`${WORKER_URL}/api/translate?text=${encodeURIComponent(title)}`);
    const data = await res.json();
    if (data.text) {
      el.className = 'tl-text';
      el.textContent = data.text;
      el.dataset.done = '1';
      btn.textContent = 'è¨³';
    } else {
      btn.textContent = 'Ã—';
    }
  } catch {
    btn.textContent = 'Ã—';
  }
}

// Delegate click for translate buttons
document.addEventListener('click', e => {
  const btn = e.target.closest('.tl-btn');
  if (btn) translateTitle(btn);
});

// â”€â”€ Pyramid â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderPyramid(grouped, nationalGL, clinicalQuestions) {
  const pyramidEl = $('#pyramid');
  const barsEl = $('#pyramid-bars');
  const counts = EV_ORDER.map(level => (grouped[level] || []).length);
  // Add national GL + CQ counts to guideline level (CQs are part of guidelines)
  const glExtra = (nationalGL ? nationalGL.length : 0) + (clinicalQuestions ? clinicalQuestions.length : 0);
  if (glExtra) counts[0] += glExtra;
  const max = Math.max(...counts, 1);

  if (counts.every(c => c === 0)) {
    pyramidEl.style.display = 'none';
    return;
  }

  let html = '';
  for (let i = 0; i < EV_ORDER.length; i++) {
    const info = EV[EV_ORDER[i]];
    const count = counts[i];
    const pct = (count / max) * 100;
    html += `
      <div class="pyramid-row">
        <div class="pyramid-label">${info.abbr}</div>
        <div class="pyramid-bar-bg">
          <div class="pyramid-bar" style="width:${pct}%;background:${info.color}"></div>
        </div>
        <div class="pyramid-val">${count}ä»¶</div>
      </div>`;
  }
  barsEl.innerHTML = html;
  pyramidEl.style.display = 'block';
}

// â”€â”€ Toolbar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let currentSort = 'relevance';

function showToolbar() {
  $('#toolbar').style.display = 'flex';
}

function sortResults(mode) {
  if (!lastData) return;
  currentSort = mode;

  // Update active button
  document.querySelectorAll('.sort-group .tb-btn').forEach(btn => {
    btn.classList.toggle('active', btn.dataset.sort === mode);
  });

  const grouped = lastData.results;
  if (mode === 'relevance') {
    // Default: grouped by evidence level, newest first within each group
    renderResults(grouped);
    return;
  }

  // Flatten all results
  const flat = [];
  for (const level of EV_ORDER) {
    for (const item of (grouped[level] || [])) {
      flat.push({ ...item, _level: level });
    }
  }

  // Sort
  if (mode === 'year-desc') flat.sort((a, b) => (b.year || 0) - (a.year || 0));
  if (mode === 'year-asc')  flat.sort((a, b) => (a.year || 0) - (b.year || 0));
  if (mode === 'cite-desc') flat.sort((a, b) => (b.citations || 0) - (a.citations || 0));

  // Render as flat list with inline evidence badges
  renderFlatResults(flat);
}

function renderFlatResults(items) {
  if (!items.length) {
    resultsEl.innerHTML = '<div class="no-results">è©²å½“ã™ã‚‹æ–‡çŒ®ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</div>';
    return;
  }
  resultsEl.innerHTML = '<div class="ev-items" style="background:#fff;border-radius:8px;padding:.5rem">'
    + items.map(item => {
      const info = EV[item.evidenceLevel || item._level || 'other'];
      const badge = `<span class="ev-badge" style="background:${info.color};font-size:.65rem;padding:.1rem .35rem;vertical-align:middle;margin-right:.3rem">${info.abbr}</span>`;
      return renderCard(item, badge);
    }).join('')
    + '</div>';
}

// â”€â”€ Export â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getAllItems() {
  if (!lastData) return [];
  const items = [];
  for (const level of EV_ORDER) {
    for (const item of (lastData.results[level] || [])) {
      items.push({ ...item, _level: level });
    }
  }
  return items;
}

function exportCSV() {
  const items = getAllItems();
  if (!items.length) return;

  const header = 'Title,Authors,Journal,Year,Evidence Level,Sources,DOI,Citations,URL';
  const rows = items.map(item => {
    const fields = [
      item.title,
      (item.authors || []).join('; '),
      item.journal,
      item.year || '',
      (EV[item.evidenceLevel] || EV.other).label,
      (item.foundIn || [item.source]).join('; '),
      item.doi || '',
      item.citations || 0,
      item.url || '',
    ];
    return fields.map(f => '"' + String(f).replace(/"/g, '""') + '"').join(',');
  });

  download('evidence-navigator.csv', '\uFEFF' + header + '\n' + rows.join('\n'), 'text/csv');
}

function exportBibTeX() {
  const items = getAllItems();
  if (!items.length) return;

  const entries = items.map((item, i) => {
    const key = item.doi
      ? item.doi.replace(/[^a-zA-Z0-9]/g, '_')
      : (item.id || 'entry' + i);
    const authors = (item.authors || []).join(' and ');
    const lines = [
      `@article{${key},`,
      `  title = {${item.title || ''}},`,
    ];
    if (authors) lines.push(`  author = {${authors}},`);
    if (item.journal) lines.push(`  journal = {${item.journal}},`);
    if (item.year) lines.push(`  year = {${item.year}},`);
    if (item.doi) lines.push(`  doi = {${item.doi}},`);
    if (item.url) lines.push(`  url = {${item.url}},`);
    lines.push('}');
    return lines.join('\n');
  });

  download('evidence-navigator.bib', entries.join('\n\n'), 'application/x-bibtex');
}

function exportRIS() {
  const items = getAllItems();
  if (!items.length) return;

  const entries = items.map(item => {
    const lines = ['TY  - JOUR'];
    if (item.title) lines.push(`TI  - ${item.title}`);
    if (item.authors) item.authors.forEach(a => lines.push(`AU  - ${a}`));
    if (item.journal) lines.push(`JO  - ${item.journal}`);
    if (item.year) lines.push(`PY  - ${item.year}`);
    if (item.doi) lines.push(`DO  - ${item.doi}`);
    if (item.url) lines.push(`UR  - ${item.url}`);
    if (item.id) lines.push(`AN  - ${item.id}`);
    lines.push('ER  - ');
    return lines.join('\n');
  });

  download('evidence-navigator.ris', entries.join('\n'), 'application/x-research-info-systems');
}

function download(filename, content, mime) {
  const blob = new Blob([content], { type: mime + ';charset=utf-8' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  a.click();
  URL.revokeObjectURL(a.href);
}

// â”€â”€ AI Settings â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function initAISettings() {
  const btn = $('#ai-settings-btn');
  const body = $('#ai-settings-body');
  btn.addEventListener('click', () => body.classList.toggle('open'));

  // Restore saved key
  const savedKey = localStorage.getItem('geminiKey');
  if (savedKey) geminiKeyInput.value = savedKey;

  // Save key on change
  geminiKeyInput.addEventListener('change', () => {
    const key = geminiKeyInput.value.trim();
    if (key) localStorage.setItem('geminiKey', key);
    else localStorage.removeItem('geminiKey');
  });
}

// â”€â”€ Tab Switching â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function switchMode(mode) {
  document.querySelectorAll('.mode-tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.search-mode').forEach(m => m.style.display = 'none');
  $(`#tab-${mode}`).classList.add('active');
  $(`#mode-${mode}`).style.display = 'block';

  // Hide/show search results depending on mode
  const resultAreas = '#summary, #translated-info, .legend, #loading, #ai-summary, #national-gl-section, #cq-section, #patient-voice-section, #ct-section, #pyramid, #toolbar, #results';
  if (mode === 'browse') {
    // Save visibility state before hiding
    document.querySelectorAll(resultAreas).forEach(el => {
      el.dataset.prevDisplay = el.style.display;
      el.style.display = 'none';
    });
    loadCQBrowser();
  } else {
    // Restore previous visibility when switching back
    document.querySelectorAll(resultAreas).forEach(el => {
      if (el.dataset.prevDisplay !== undefined) {
        el.style.display = el.dataset.prevDisplay;
        delete el.dataset.prevDisplay;
      }
    });
  }
}

// â”€â”€ CQ Browser â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let browseCache = null;

// Synonym groups for cross-language & variant matching
const SYNONYM_GROUPS = [
  ['stroke', 'cva', 'cerebrovascular', 'è„³å’ä¸­', 'è„³è¡€ç®¡éšœå®³', 'è„³æ¢—å¡', 'è„³å‡ºè¡€', 'ç‰‡éº»ç—º'],
  ['tbi', 'traumatic brain injury', 'brain injury', 'å¤–å‚·æ€§è„³æå‚·', 'è„³æå‚·', 'é ­éƒ¨å¤–å‚·'],
  ['mtbi', 'concussion', 'è„³éœ‡ç›ª', 'è»½åº¦å¤–å‚·æ€§è„³æå‚·'],
  ['sci', 'spinal cord injury', 'è„Šé«„æå‚·', 'è„Šæ'],
  ['multiple sclerosis', 'ms', 'å¤šç™ºæ€§ç¡¬åŒ–ç—‡'],
  ["parkinson", "parkinson's", "ãƒ‘ãƒ¼ã‚­ãƒ³ã‚½ãƒ³", 'ãƒ‘ãƒ¼ã‚­ãƒ³ã‚½ãƒ³ç—…'],
  ['dementia', 'alzheimer', 'èªçŸ¥ç—‡', 'ã‚¢ãƒ«ãƒ„ãƒã‚¤ãƒãƒ¼'],
  ['cerebral palsy', 'cp', 'è„³æ€§éº»ç—º'],
  ['als', 'amyotrophic lateral sclerosis', 'ç­‹èç¸®æ€§å´ç´¢ç¡¬åŒ–ç—‡'],
  ['myasthenia gravis', 'mg', 'é‡ç—‡ç­‹ç„¡åŠ›ç—‡'],
  ['epilepsy', 'ã¦ã‚“ã‹ã‚“'],
  ['low back pain', 'lbp', 'è…°ç—›', 'back pain'],
  ['neck pain', 'é ¸éƒ¨ç—›', 'é šæ¤', 'cervical'],
  ['knee oa', 'knee osteoarthritis', 'è†oa', 'å¤‰å½¢æ€§è†é–¢ç¯€ç—‡', 'gonarthrosis'],
  ['hip oa', 'hip osteoarthritis', 'è‚¡é–¢ç¯€oa', 'å¤‰å½¢æ€§è‚¡é–¢ç¯€ç—‡', 'coxarthrosis'],
  ['osteoarthritis', 'oa', 'å¤‰å½¢æ€§é–¢ç¯€ç—‡'],
  ['rheumatoid arthritis', 'ra', 'é–¢ç¯€ãƒªã‚¦ãƒãƒ'],
  ['osteoporosis', 'éª¨ç²—é¬†ç—‡'],
  ['hip fracture', 'å¤§è…¿éª¨éª¨æŠ˜', 'å¤§è…¿éª¨é ¸éƒ¨éª¨æŠ˜'],
  ['shoulder pain', 'è‚©ç—›', 'è‚©é–¢ç¯€å‘¨å›²ç‚', 'äº”åè‚©', 'frozen shoulder'],
  ['cardiac rehabilitation', 'cardiac rehab', 'å¿ƒè‡“ãƒªãƒ', 'å¿ƒãƒªãƒ'],
  ['heart failure', 'hf', 'chf', 'å¿ƒä¸å…¨'],
  ['myocardial infarction', 'mi', 'ami', 'å¿ƒç­‹æ¢—å¡'],
  ['copd', 'chronic obstructive pulmonary disease', 'æ…¢æ€§é–‰å¡æ€§è‚ºç–¾æ‚£'],
  ['pulmonary rehabilitation', 'pulmonary rehab', 'å‘¼å¸ãƒªãƒ', 'è‚ºãƒªãƒ'],
  ['asthma', 'å–˜æ¯', 'æ°—ç®¡æ”¯å–˜æ¯'],
  ['cancer', 'oncology', 'ãŒã‚“', 'æ‚ªæ€§è…«ç˜'],
  ['lung cancer', 'è‚ºãŒã‚“', 'è‚ºç™Œ'],
  ['breast cancer', 'ä¹³ãŒã‚“', 'ä¹³ç™Œ'],
  ['dysphagia', 'swallowing', 'åš¥ä¸‹éšœå®³', 'åš¥ä¸‹'],
  ['aphasia', 'å¤±èª', 'å¤±èªç—‡'],
  ['spasticity', 'ç—™ç¸®', 'ç—™æ€§'],
  ['botulinum toxin', 'botox', 'btx', 'ãƒœãƒ„ãƒªãƒŒã‚¹', 'ãƒœãƒˆãƒƒã‚¯ã‚¹'],
  ['depression', 'ã†ã¤', 'ã†ã¤ç—…', 'æŠ‘ã†ã¤'],
  ['diabetes', 'dm', 'ç³–å°¿ç—…'],
  ['ckd', 'chronic kidney disease', 'æ…¢æ€§è…è‡“ç—…'],
  ['sepsis', 'æ•—è¡€ç—‡'],
  ['burn', 'ç†±å‚·', 'ã‚„ã‘ã©'],
  ['pressure injury', 'pressure ulcer', 'decubitus', 'è¤¥ç˜¡', 'ã˜ã‚‡ããã†'],
  ['falls', 'fall prevention', 'è»¢å€’', 'è»¢å€’äºˆé˜²'],
  ['frailty', 'ãƒ•ãƒ¬ã‚¤ãƒ«', 'è™šå¼±'],
  ['sarcopenia', 'ã‚µãƒ«ã‚³ãƒšãƒ‹ã‚¢'],
  ['lymphedema', 'lymphoedema', 'ãƒªãƒ³ãƒ‘æµ®è…«'],
  ['overactive bladder', 'oab', 'éæ´»å‹•è†€èƒ±'],
  ['incontinence', 'å¤±ç¦', 'å°¿å¤±ç¦'],
  ['pain', 'ç–¼ç—›', 'ç—›ã¿'],
  ['chronic pain', 'æ…¢æ€§ç–¼ç—›'],
  ['neuropathic pain', 'ç¥çµŒéšœå®³æ€§ç–¼ç—›'],
  ['delirium', 'ã›ã‚“å¦„'],
  ['sleep apnea', 'sas', 'osas', 'ç¡çœ æ™‚ç„¡å‘¼å¸'],
  ['insomnia', 'ä¸çœ ', 'ä¸çœ ç—‡'],
  ['covid', 'covid-19', 'sars-cov-2', 'ã‚³ãƒ­ãƒŠ'],
  ['rehabilitation', 'rehab', 'ãƒªãƒãƒ“ãƒªãƒ†ãƒ¼ã‚·ãƒ§ãƒ³', 'ãƒªãƒãƒ“ãƒª', 'ãƒªãƒ'],
  ['physical therapy', 'physiotherapy', 'pt', 'ç†å­¦ç™‚æ³•'],
  ['occupational therapy', 'ot', 'ä½œæ¥­ç™‚æ³•'],
  ['speech therapy', 'speech-language', 'slt', 'slp', 'è¨€èªç™‚æ³•', 'è¨€èªè´è¦š'],
  ['exercise', 'exercise therapy', 'é‹å‹•ç™‚æ³•', 'é‹å‹•'],
  ['aerobic exercise', 'aerobic training', 'æœ‰é…¸ç´ é‹å‹•'],
  ['resistance training', 'strength training', 'ç­‹åŠ›ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°', 'ãƒ¬ã‚¸ã‚¹ã‚¿ãƒ³ã‚¹'],
  ['gait', 'walking', 'ambulation', 'æ­©è¡Œ'],
  ['balance', 'ãƒãƒ©ãƒ³ã‚¹', 'å¹³è¡¡'],
  ['fes', 'functional electrical stimulation', 'æ©Ÿèƒ½çš„é›»æ°—åˆºæ¿€'],
  ['tens', 'transcutaneous electrical nerve stimulation', 'çµŒçš®çš„é›»æ°—åˆºæ¿€'],
  ['tms', 'rtms', 'transcranial magnetic stimulation', 'çµŒé ­è“‹ç£æ°—åˆºæ¿€'],
  ['tdcs', 'transcranial direct current stimulation', 'çµŒé ­è“‹ç›´æµåˆºæ¿€'],
  ['cimt', 'constraint-induced', 'ciç™‚æ³•', 'ci therapy'],
  ['mirror therapy', 'ãƒŸãƒ©ãƒ¼ã‚»ãƒ©ãƒ”ãƒ¼', 'ãƒŸãƒ©ãƒ¼ç™‚æ³•'],
  ['virtual reality', 'vr', 'ä»®æƒ³ç¾å®Ÿ'],
  ['robot', 'robotic', 'ãƒ­ãƒœãƒƒãƒˆ'],
  ['telerehabilitation', 'telehealth', 'tele-rehab', 'é éš”ãƒªãƒ', 'ãƒ†ãƒ¬ãƒªãƒ'],
  ['early mobilization', 'early mobilisation', 'æ—©æœŸé›¢åºŠ', 'æ—©æœŸãƒªãƒ'],
  ['adl', 'activities of daily living', 'æ—¥å¸¸ç”Ÿæ´»å‹•ä½œ'],
  ['tai chi', 'taichi', 'å¤ªæ¥µæ‹³'],
  ['nutrition', 'æ „é¤Š'],
  ['cognitive', 'cognition', 'èªçŸ¥'],
  ['amputation', 'åˆ‡æ–­'],
  ['wheelchair', 'è»Šæ¤…å­', 'è»Šã„ã™'],
  ['orthotics', 'orthosis', 'è£…å…·'],
  ['prosthetics', 'prosthesis', 'ç¾©è‚¢', 'ç¾©è¶³', 'ç¾©æ‰‹'],
  ['vocational rehabilitation', 'return to work', 'è·æ¥­ãƒªãƒ', 'å¾©è·', 'å°±åŠ´æ”¯æ´'],
  ['acl', 'anterior cruciate ligament', 'å‰åå­—é­å¸¯', 'å‰åå­—é±å¸¯'],
  ['pelvic floor', 'pfmt', 'éª¨ç›¤åº•', 'éª¨ç›¤åº•ç­‹'],
  ['pregnancy', 'prenatal', 'postpartum', 'å¦Šå¨ ', 'ç”£å¾Œ', 'å‘¨ç”£æœŸ'],
  ['palliative', 'hospice', 'ç·©å’Œã‚±ã‚¢', 'çµ‚æœ«æœŸ'],
  ['fatigue', 'ç–²åŠ´', 'å€¦æ€ æ„Ÿ', 'cancer-related fatigue'],
  ['cbt', 'cognitive behavioral therapy', 'cognitive behavioural therapy', 'èªçŸ¥è¡Œå‹•ç™‚æ³•'],
  ['driving', 'fitness to drive', 'è‡ªå‹•è»Šé‹è»¢', 'é‹è»¢'],
  ['autonomic dysreflexia', 'è‡ªå¾‹ç¥çµŒéåå°„'],
  ['neurogenic bowel', 'ç¥çµŒå› æ€§è…¸', 'æ’ä¾¿éšœå®³'],
  ['neurogenic bladder', 'ç¥çµŒå› æ€§è†€èƒ±'],
  ['down syndrome', 'trisomy 21', 'ãƒ€ã‚¦ãƒ³ç—‡'],
  ['spina bifida', 'myelomeningocele', 'äºŒåˆ†è„Šæ¤'],
  ['dcd', 'developmental coordination disorder', 'ç™ºé”æ€§å”èª¿é‹å‹•éšœå®³'],
  ['duchenne', 'dmd', 'ãƒ‡ãƒ¥ã‚·ã‚§ãƒ³ãƒŒå‹ç­‹ã‚¸ã‚¹ãƒˆãƒ­ãƒ•ã‚£ãƒ¼'],
  ['cga', 'comprehensive geriatric assessment', 'é«˜é½¢è€…ç·åˆæ©Ÿèƒ½è©•ä¾¡'],
  ['pics', 'post-intensive care syndrome', 'icu-acquired weakness', 'icu-aw', 'ICUå¾Œç—‡å€™ç¾¤'],
  ['hfref', 'hfpef', 'å¿ƒä¸å…¨', 'åç¸®ä¸å…¨', 'æ‹¡å¼µä¸å…¨'],
  ['renal rehabilitation', 'kidney', 'è…è‡“ãƒªãƒ', 'é€æ'],
  ['hemodialysis', 'dialysis', 'è¡€æ¶²é€æ', 'é€æ'],
];

function expandSynonyms(word) {
  const w = word.toLowerCase();
  const result = [w];
  for (const group of SYNONYM_GROUPS) {
    if (group.some(s => s === w || (w.length > 2 && s.includes(w)) || (s.length > 2 && w.includes(s)))) {
      for (const s of group) {
        if (!result.includes(s)) result.push(s);
      }
    }
  }
  return result;
}

// Word boundary match for short terms (<=4 chars) to prevent "acl" matching "baclofen"
function matchTerm(text, term) {
  if (term.length <= 4 && /^[a-z\-]+$/.test(term)) {
    // ASCII short terms: require word boundary
    const re = new RegExp('\\b' + term.replace(/[-]/g, '\\-') + '\\b', 'i');
    return re.test(text);
  }
  return text.includes(term);
}

async function loadCQBrowser() {
  const listEl = $('#browse-list');
  const statsEl = $('#browse-stats');
  const catParam = $('#browse-cat').value;
  const filterText = ($('#browse-filter').value || '').trim().toLowerCase();
  const filterWords = filterText ? filterText.split(/\s+/) : [];

  // Expand synonyms: each word becomes [word, ...synonyms]
  const expandedFilters = filterWords.map(w => expandSynonyms(w));

  if (!browseCache) {
    listEl.innerHTML = '<div style="text-align:center;padding:1rem;color:#94a3b8">èª­ã¿è¾¼ã¿ä¸­...</div>';
    try {
      const res = await fetch(`${WORKER_URL}/api/cq/list`);
      browseCache = await res.json();
    } catch (e) {
      listEl.innerHTML = '<div class="error-msg">èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼</div>';
      return;
    }
  }

  let groups = browseCache.groups;
  if (catParam) groups = groups.filter(g => g.cat === catParam);
  const countryParam = $('#browse-country').value;
  if (countryParam) {
    if (countryParam === 'INT') {
      groups = groups.filter(g => g.country === 'INT' || g.country === 'INTL');
    } else {
      groups = groups.filter(g => g.country === countryParam || (g.country || '').startsWith(countryParam));
    }
  }

  // Keyword filter with synonym expansion (bilingual)
  if (expandedFilters.length) {
    groups = groups.map(g => {
      const filteredCQs = g.cqs.filter(cq => {
        const text = (cq.question + ' ' + g.title + ' ' + (g.titleEn || '') + ' ' + (cq.kw || []).join(' ')).toLowerCase();
        return expandedFilters.every(syns => syns.some(s => matchTerm(text, s)));
      });
      return filteredCQs.length ? { ...g, cqs: filteredCQs } : null;
    }).filter(Boolean);
  }

  const totalCQs = groups.reduce((s, g) => s + g.cqs.length, 0);
  const allTotal = browseCache.groups.reduce((s, g) => s + g.cqs.length, 0);
  if (expandedFilters.length) {
    statsEl.innerHTML = `<strong style="color:#6d28d9">${totalCQs}ä»¶ãƒ’ãƒƒãƒˆ</strong> / ${allTotal} CQs`;
  } else {
    statsEl.textContent = `${groups.length}ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³ / ${totalCQs} CQs`;
  }
  // Show/hide clear button
  const clearBtn = $('#browse-filter-clear');
  if (clearBtn) clearBtn.style.display = filterText ? 'block' : 'none';

  const evColors = { A: '#059669', B: '#2563eb', C: '#d97706', D: '#ef4444', '-': '#94a3b8' };
  const countryFlags = {JP:'\u{1F1EF}\u{1F1F5}',US:'\u{1F1FA}\u{1F1F8}',UK:'\u{1F1EC}\u{1F1E7}',EU:'\u{1F1EA}\u{1F1FA}',CN:'\u{1F1E8}\u{1F1F3}',AU:'\u{1F1E6}\u{1F1FA}',CA:'\u{1F1E8}\u{1F1E6}',KR:'\u{1F1F0}\u{1F1F7}',TW:'\u{1F1F9}\u{1F1FC}',IN:'\u{1F1EE}\u{1F1F3}',DE:'\u{1F1E9}\u{1F1EA}',IT:'\u{1F1EE}\u{1F1F9}',ZA:'\u{1F1FF}\u{1F1E6}',QA:'\u{1F1F6}\u{1F1E6}',BR:'\u{1F1E7}\u{1F1F7}',INT:'\u{1F30D}',INTL:'\u{1F30D}'};

  const autoOpen = expandedFilters.length > 0;
  if (autoOpen && groups.length === 0) {
    listEl.innerHTML = '<div style="text-align:center;padding:2rem;color:#94a3b8">è©²å½“ã™ã‚‹CQãŒã‚ã‚Šã¾ã›ã‚“</div>';
    return;
  }
  listEl.innerHTML = groups.map(g => {
    const glIsEn = !/[\u3000-\u9FFF\uF900-\uFAFF]/.test(g.title);
    const flag = countryFlags[g.country] || '';
    return `
    <div class="browse-gl${autoOpen ? ' open' : ''}" data-gid="${esc(g.gid)}">
      <div class="browse-gl-header" onclick="this.parentElement.classList.toggle('open')">
        <span>
          ${flag ? `<span style="margin-right:.3rem" title="${esc(g.country)}">${flag}</span>` : ''}${esc(g.title)}
          ${glIsEn ? `<button class="tl-btn" onclick="event.stopPropagation();translateGLTitle(this)" title="æ—¥æœ¬èªã«ç¿»è¨³" style="margin-left:.3rem">è¨³</button>` : ''}
          ${g.url ? `<a href="${esc(g.url)}" target="_blank" rel="noopener" onclick="event.stopPropagation()" title="ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³åŸæ–‡ã‚’é–‹ã" style="display:inline-flex;align-items:center;gap:.2rem;margin-left:.4rem;padding:.15rem .45rem;background:#6d28d9;color:#fff;font-size:.65rem;font-weight:600;border-radius:4px;text-decoration:none;white-space:nowrap;vertical-align:middle">åŸæ–‡ &#8599;</a>` : ''}
          <small style="color:#94a3b8">${esc(g.org)}</small>
        </span>
        <span class="browse-gl-badge">${g.cqs.length} CQs</span>
      </div>
      <div class="browse-gl-body">
        ${g.cqs.map(cq => {
          const isEn = !/[\u3000-\u9FFF\uF900-\uFAFF]/.test(cq.question);
          return `
          <div class="browse-cq" data-q="${esc(cq.question)}" data-kw="${esc((cq.kw || []).filter(k => /^[A-Za-z\s\-]+$/.test(k)).join(','))}" style="cursor:pointer" title="ã‚¯ãƒªãƒƒã‚¯ã§ã“ã®CQã«é–¢é€£ã™ã‚‹æ–‡çŒ®ã‚’æ¤œç´¢">
            <div style="display:flex;align-items:center;gap:.3rem">
              <span class="browse-cq-num">${esc(cq.cq)}</span>
              <span class="browse-cq-ev" style="background:${evColors[cq.evidenceLevel] || '#94a3b8'}">${cq.evidenceLevel}</span>
              ${isEn ? `<button class="tl-btn" onclick="event.stopPropagation();translateCQ(this)" title="æ—¥æœ¬èªã«ç¿»è¨³">è¨³</button>` : ''}
              ${cq.page ? `<a href="${esc(g.url)}#page=${cq.page}" target="_blank" rel="noopener" class="cq-page-link" title="PDFè©²å½“ãƒšãƒ¼ã‚¸" onclick="event.stopPropagation()">p.${cq.page}</a>` : ''}
            </div>
            <span class="browse-cq-q">${esc(cq.question)}</span>
          </div>`;
        }).join('')}
      </div>
    </div>`;
  }).join('');

  // CQ click â†’ inline PubMed SR/RCT evidence search
  listEl.querySelectorAll('.browse-cq').forEach(el => {
    el.addEventListener('click', (e) => {
      e.stopPropagation();
      const q = el.dataset.q;
      const kw = el.dataset.kw || '';
      if (!q) return;
      toggleCQEvidence(el, q, kw);
    });
  });
}

// â”€â”€ CQ Translate (MyMemory API) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

const translateCache = new Map();

async function fetchTranslation(text) {
  if (translateCache.has(text)) return translateCache.get(text);
  const res = await fetch(
    `https://api.mymemory.translated.net/get?q=${encodeURIComponent(text)}&langpair=en|ja`,
    { signal: AbortSignal.timeout(8000) }
  );
  const data = await res.json();
  const translated = data.responseData?.translatedText || '';
  if (translated) translateCache.set(text, translated);
  return translated;
}

async function translateCQ(btn) {
  const qEl = btn.closest('.browse-cq').querySelector('.browse-cq-q');
  const existing = qEl.querySelector('.browse-cq-ja');
  if (existing) { existing.remove(); btn.textContent = 'è¨³'; return; }

  const text = qEl.childNodes[0].textContent.trim();
  if (translateCache.has(text)) {
    appendJa(qEl, translateCache.get(text));
    btn.textContent = 'âœ•';
    return;
  }

  btn.classList.add('loading'); btn.textContent = 'â€¦';
  try {
    const translated = await fetchTranslation(text);
    if (!translated) { btn.textContent = 'è¨³'; btn.classList.remove('loading'); return; }
    appendJa(qEl, translated);
    btn.textContent = 'âœ•';
  } catch (e) {
    btn.textContent = '!'; btn.title = 'ç¿»è¨³ã‚¨ãƒ©ãƒ¼';
    setTimeout(() => { btn.textContent = 'è¨³'; btn.title = 'æ—¥æœ¬èªã«ç¿»è¨³'; }, 2000);
  }
  btn.classList.remove('loading');
}

async function translateGLTitle(btn) {
  const headerSpan = btn.closest('span');
  const existing = headerSpan.querySelector('.browse-cq-ja');
  if (existing) { existing.remove(); btn.textContent = 'è¨³'; return; }

  const linkOrText = headerSpan.querySelector('a') || headerSpan;
  const text = (linkOrText.textContent || '').trim();
  if (translateCache.has(text)) {
    appendJa(headerSpan, translateCache.get(text));
    btn.textContent = 'âœ•';
    return;
  }

  btn.classList.add('loading'); btn.textContent = 'â€¦';
  try {
    const translated = await fetchTranslation(text);
    if (!translated) { btn.textContent = 'è¨³'; btn.classList.remove('loading'); return; }
    appendJa(headerSpan, translated);
    btn.textContent = 'âœ•';
  } catch (e) {
    btn.textContent = '!'; btn.title = 'ç¿»è¨³ã‚¨ãƒ©ãƒ¼';
    setTimeout(() => { btn.textContent = 'è¨³'; btn.title = 'æ—¥æœ¬èªã«ç¿»è¨³'; }, 2000);
  }
  btn.classList.remove('loading');
}

function appendJa(parent, text) {
  const ja = document.createElement('span');
  ja.className = 'browse-cq-ja';
  ja.textContent = text;
  parent.appendChild(ja);
}

// â”€â”€ CQ Evidence (inline PubMed SR/RCT search) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

const cqEvCache = new Map(); // q â†’ results

async function toggleCQEvidence(el, q, kw) {
  // Toggle: if already open, close
  const existing = el.nextElementSibling;
  if (existing && existing.classList.contains('cq-evidence-panel')) {
    existing.remove();
    return;
  }

  // Create panel
  const panel = document.createElement('div');
  panel.className = 'cq-evidence-panel';
  panel.innerHTML = '<div class="cq-ev-loading">PubMedã‹ã‚‰é–¢é€£SR/RCTã‚’æ¤œç´¢ä¸­...</div>';
  el.insertAdjacentElement('afterend', panel);

  // Check cache
  const cacheKey = q + '|' + kw;
  if (cqEvCache.has(cacheKey)) {
    renderCQEvidence(panel, cqEvCache.get(cacheKey), q);
    return;
  }

  try {
    let apiUrl = `${WORKER_URL}/api/cq/evidence?q=${encodeURIComponent(q)}`;
    if (kw) apiUrl += `&kw=${encodeURIComponent(kw)}`;
    const res = await fetch(apiUrl, {
      signal: AbortSignal.timeout(12000),
    });
    const data = await res.json();
    cqEvCache.set(cacheKey, data);
    renderCQEvidence(panel, data, q);
  } catch (e) {
    panel.innerHTML = `<div style="color:#ef4444">æ¤œç´¢ã‚¨ãƒ©ãƒ¼: ${esc(e.message)}</div>`;
  }
}

function renderCQEvidence(panel, data, q) {
  const results = data.results || [];
  const typeLabels = { sr_ma: 'SR/MA', rct: 'RCT', guideline: 'GL', clinical_trial: 'CT', other: '' };

  if (!results.length) {
    panel.innerHTML = `
      <div class="cq-ev-header">
        <span>é–¢é€£ã‚¨ãƒ“ãƒ‡ãƒ³ã‚¹</span>
        <span class="cq-ev-close" onclick="this.closest('.cq-evidence-panel').remove()">é–‰ã˜ã‚‹</span>
      </div>
      <div style="color:#94a3b8;padding:.3rem 0">SR/RCTãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ</div>
      <div style="color:#94a3b8;font-size:.6rem">æ¤œç´¢èª: ${esc((data.keywords || []).join(', '))}</div>`;
    return;
  }

  panel.innerHTML = `
    <div class="cq-ev-header">
      <span>é–¢é€£ã‚¨ãƒ“ãƒ‡ãƒ³ã‚¹ (${results.length}ä»¶)</span>
      <span class="cq-ev-close" onclick="this.closest('.cq-evidence-panel').remove()">é–‰ã˜ã‚‹</span>
    </div>
    ${results.map(r => `
      <div class="cq-ev-item">
        <span class="cq-ev-type cq-ev-type-${r.type}">${typeLabels[r.type] || r.type}</span>
        <a href="${esc(r.url)}" target="_blank" rel="noopener">${esc(r.title)}</a>
        <div class="cq-ev-meta">${esc(r.authors.join(', '))}${r.year ? ' (' + r.year + ')' : ''} - ${esc(r.journal)}</div>
      </div>
    `).join('')}
    <div style="margin-top:.3rem;text-align:right">
      <a href="https://pubmed.ncbi.nlm.nih.gov/?term=${encodeURIComponent((data.keywords || []).join(' AND ') + ' AND (systematic review[pt] OR meta-analysis[pt] OR randomized controlled trial[pt])')}" target="_blank" rel="noopener" style="color:#7c3aed;font-size:.65rem;text-decoration:none">PubMedã§å…¨ä»¶è¡¨ç¤º &rarr;</a>
    </div>`;
}

// â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function init() {
  // Simple search: suggest autocomplete
  initSuggest(qInput, $('#q-ac'), true);

  // Advanced search: MeSH autocomplete
  initAutocomplete(diseaseInput, $('#disease-ac'));
  initAutocomplete(treatmentInput, $('#treatment-ac'));
  initAutocomplete(topicInput, $('#topic-ac'));
  initAISettings();

  // Search buttons
  searchBtn.addEventListener('click', doSearch);
  if (searchBtnAdv) searchBtnAdv.addEventListener('click', doSearch);

  // Tab switching
  document.querySelectorAll('.mode-tab').forEach(tab => {
    tab.addEventListener('click', () => switchMode(tab.dataset.mode));
  });

  // Search chips
  document.querySelectorAll('.chip').forEach(chip => {
    chip.addEventListener('click', () => {
      qInput.value = chip.dataset.q;
      doSearch();
    });
  });

  // Browse category filter + keyword filter
  $('#browse-cat').addEventListener('change', () => loadCQBrowser());
  $('#browse-country').addEventListener('change', () => loadCQBrowser());
  let browseFilterTimer = null;
  $('#browse-filter').addEventListener('input', () => {
    clearTimeout(browseFilterTimer);
    browseFilterTimer = setTimeout(() => loadCQBrowser(), 200);
  });
  $('#browse-filter').addEventListener('focus', () => {
    $('#browse-filter').style.borderColor = '#8b5cf6';
  });
  $('#browse-filter').addEventListener('blur', () => {
    $('#browse-filter').style.borderColor = '#cbd5e1';
  });
  $('#browse-filter-clear').addEventListener('click', () => {
    $('#browse-filter').value = '';
    loadCQBrowser();
  });

  // Sort buttons
  document.querySelectorAll('.sort-group .tb-btn').forEach(btn => {
    btn.addEventListener('click', () => sortResults(btn.dataset.sort));
  });
  // Export buttons
  $('#export-csv').addEventListener('click', exportCSV);
  $('#export-ris').addEventListener('click', exportRIS);
  $('#export-bib').addEventListener('click', exportBibTeX);

  // Search mode toggle (æ–‡çŒ®æ¤œç´¢ / æ‚£è€…ã®å£°)
  document.querySelectorAll('.smt-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.smt-btn').forEach(b => {
        b.style.background = '#fff'; b.style.color = '#64748b';
        b.classList.remove('active');
      });
      btn.classList.add('active');
      const isPV = btn.dataset.smode === 'patientvoice';
      if (isPV) {
        btn.style.background = '#f59e0b'; btn.style.color = '#fff';
      } else {
        btn.style.background = '#3b82f6'; btn.style.color = '#fff';
      }
      $('#patient-voice').checked = isPV;
      // Auto re-search if there's a query
      const q = qInput.value.trim();
      if (q) executeSearch(q);
    });
  });

  // Search history
  renderSearchHistory();
  $('#clear-history').addEventListener('click', () => {
    localStorage.removeItem(HISTORY_KEY);
    renderSearchHistory();
  });

  // Restore from URL params
  const params = new URLSearchParams(location.search);
  if (params.get('q')) {
    qInput.value = params.get('q');
    doSearch();
  } else if (params.get('disease') || params.get('treatment') || params.get('topic')) {
    switchMode('advanced');
    if (params.get('disease'))      diseaseInput.value = params.get('disease');
    if (params.get('treatment'))    treatmentInput.value = params.get('treatment');
    if (params.get('topic'))        topicInput.value = params.get('topic');
    if (params.get('multilingual')) $('#multilingual-adv').checked = true;
    doSearch();
  }
}

init();
</script>
</body>
</html>
